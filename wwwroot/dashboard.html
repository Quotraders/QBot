<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TopstepX Trading Bot Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0e16; color: #e0e6ed; }
    .container { display: flex; height: 100vh; }
    .main-content { flex: 1; padding: 20px; overflow-y: auto; }
    .sidebar { width: 300px; background: #161b22; padding: 20px; overflow-y: auto; }
    .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px; }
    .logo { font-size: 24px; font-weight: bold; color: #4CAF50; }
    .status-indicator { display: flex; align-items: center; gap: 10px; }
    .status-dot { width: 12px; height: 12px; border-radius: 50%; }
    .status-dot.online { background: #4CAF50; animation: pulse 2s infinite; }
    .status-dot.offline { background: #f44336; }
    .status-dot.connecting { background: #ffa657; animation: pulse 1s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    
    /* Enhanced animations for live data */
    @keyframes glow { 
      0%, 100% { box-shadow: 0 0 5px rgba(76, 175, 80, 0.5); }
      50% { box-shadow: 0 0 20px rgba(76, 175, 80, 0.8); }
    }
    @keyframes slideInRight { 
      from { transform: translateX(10px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes fadeInScale { 
      from { transform: scale(0.95); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    @keyframes liveBounce { 
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .live-update { animation: slideInRight 0.3s ease-out; }
    .live-glow { animation: glow 2s infinite; }
    .live-bounce { animation: liveBounce 0.5s ease-out; }
    
    .tabs { display: flex; border-bottom: 2px solid #30363d; margin-bottom: 20px; overflow-x: auto; }
    .tab { padding: 12px 24px; cursor: pointer; border: none; background: none; color: #8b949e; font-size: 14px; white-space: nowrap; }
    .tab.active { color: #4CAF50; border-bottom: 2px solid #4CAF50; }
    .tab:hover { color: #f0f6fc; }
    
    /* Cloud Learning Specific Styles */
    .cloud-status { display: flex; align-items: center; gap: 8px; margin: 16px 0; }
    .cloud-status-dot { width: 10px; height: 10px; border-radius: 50%; }
    .cloud-status-dot.training { background: #ffa657; animation: pulse 1s infinite; }
    .cloud-status-dot.active { background: #4CAF50; }
    .cloud-status-dot.failed { background: #f44336; }
    .cloud-status-dot.idle { background: #8b949e; }
    
    .badge { 
      display: inline-block; 
      padding: 4px 8px; 
      border-radius: 12px; 
      font-size: 11px; 
      font-weight: bold; 
      text-transform: uppercase; 
    }
    .badge.success { background: #4CAF50; color: white; }
    .badge.warning { background: #ffa657; color: white; }
    .badge.error { background: #f44336; color: white; }
    .badge.info { background: #58a6ff; color: white; }
    
    .action-buttons { display: flex; gap: 8px; margin: 16px 0; flex-wrap: wrap; }
    .action-btn { 
      padding: 8px 12px; 
      border: 1px solid #30363d; 
      background: #21262d; 
      color: #e0e6ed; 
      border-radius: 6px; 
      cursor: pointer; 
      font-size: 12px; 
      text-decoration: none; 
      display: inline-flex; 
      align-items: center; 
      gap: 4px;
    }
    .action-btn:hover { background: #30363d; }
    .action-btn.primary { background: #238636; border-color: #238636; }
    .action-btn.primary:hover { background: #2ea043; }
    
    .workflow-status { 
      display: flex; 
      align-items: center; 
      gap: 12px; 
      padding: 12px; 
      background: #0d1117; 
      border-radius: 6px; 
      margin-bottom: 12px; 
    }
    
    .model-update-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #0d1117;
      border-radius: 6px;
      margin: 8px 0;
    }
    
    .progress-ring {
      display: inline-block;
      width: 40px;
      height: 40px;
      transform: rotate(-90deg);
    }
    
    .progress-ring__circle {
      stroke: #4CAF50;
      stroke-width: 4;
      fill: transparent;
      stroke-dasharray: 125.6;
      stroke-dashoffset: 125.6;
      transition: stroke-dashoffset 0.3s ease;
    }
    
    .mini-chart {
      width: 100%;
      height: 120px;
      background: #0d1117;
      border-radius: 6px;
      padding: 8px;
      margin: 8px 0;
    }
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .card { background: #161b22; border: 1px solid #30363d; border-radius: 8px; margin-bottom: 20px; }
    .card-header { padding: 16px; border-bottom: 1px solid #30363d; display: flex; justify-content: space-between; align-items: center; }
    .card-title { font-weight: 600; font-size: 16px; }
    .card-body { padding: 16px; }
    
    .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
    .metric-card { background: #0d1117; border: 1px solid #21262d; border-radius: 6px; padding: 16px; text-align: center; transition: all 0.3s ease; }
    .metric-card:hover { border-color: #30363d; background: #161b22; }
    .metric-value { font-size: 28px; font-weight: bold; margin-bottom: 8px; transition: all 0.3s ease; }
    .metric-label { font-size: 14px; color: #8b949e; }
    .metric-value.good { color: #4CAF50; }
    .metric-value.bad { color: #f85149; }
    .metric-value.neutral { color: #ffa657; }
    .metric-value.live { animation: liveBounce 0.5s ease-out; }
    
    /* Enhanced countdown styling */
    .session-status { 
      padding: 4px 8px; 
      border-radius: 12px; 
      font-size: 11px; 
      font-weight: bold; 
      text-transform: uppercase; 
      transition: all 0.3s ease;
    }
    .session-status.active { 
      background: #4CAF50; 
      color: white; 
      animation: glow 2s infinite;
    }
    .session-status.waiting { 
      background: #ffa657; 
      color: white; 
      animation: pulse 2s infinite;
    }
    .session-status.closed { 
      background: #8b949e; 
      color: white; 
    }
    
    .countdown-info { 
      font-size: 12px; 
      color: #8b949e; 
      margin-top: 4px;
      transition: color 0.3s ease;
    }
    .countdown-info.live { color: #4CAF50; animation: pulse 1s infinite; }
    
    .learning-status { display: flex; align-items: center; gap: 10px; margin: 16px 0; }
    .learning-dot { width: 8px; height: 8px; border-radius: 50%; background: #4CAF50; animation: pulse 1.5s infinite; }
    
    /* Enhanced learning display */
    .learning-progress-container { 
      background: #0d1117; 
      border: 1px solid #21262d; 
      border-radius: 6px; 
      padding: 12px; 
      margin: 8px 0;
    }
    .learning-stage { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin: 4px 0; 
      font-size: 12px;
    }
    .learning-stage.active { color: #4CAF50; animation: pulse 1s infinite; }
    .learning-accuracy-display { 
      font-size: 16px; 
      font-weight: bold; 
      color: #4CAF50; 
      text-align: center; 
      margin: 8px 0;
    }
    .learning-log-mini { 
      height: 120px; 
      overflow-y: auto; 
      background: #0a0e16; 
      border-radius: 4px; 
      padding: 8px; 
      margin: 8px 0; 
      font-family: monospace; 
      font-size: 11px;
    }
    
    .log-container { background: #0d1117; border: 1px solid #21262d; border-radius: 6px; height: 400px; overflow-y: auto; }
    .log-controls { padding: 12px; border-bottom: 1px solid #21262d; display: flex; gap: 8px; }
    .log-filter { padding: 6px 12px; border: 1px solid #30363d; background: #161b22; color: #e0e6ed; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .log-filter.active { background: #4CAF50; color: white; }
    .log-stream { padding: 12px; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.4; }
    .log-entry { margin-bottom: 4px; }
    .log-entry.info { color: #58a6ff; }
    .log-entry.warning { color: #d29922; }
    .log-entry.error { color: #f85149; }
    .log-entry.success { color: #3fb950; }
    .log-entry.learning { color: #a5b4fc; }
    
    .actions { display: flex; gap: 12px; margin-bottom: 20px; }
    .btn { padding: 8px 16px; border: 1px solid #30363d; background: #21262d; color: #e0e6ed; border-radius: 6px; cursor: pointer; font-size: 14px; }
    .btn:hover { background: #30363d; }
    .btn.primary { background: #238636; border-color: #238636; }
    .btn.primary:hover { background: #2ea043; }
    .btn.danger { background: #da3633; border-color: #da3633; }
    .btn.danger:hover { background: #f85149; }
    
    .connection-status { padding: 12px; border-radius: 6px; margin-bottom: 16px; }
    .connection-status.connected { background: rgba(63, 185, 80, 0.1); border: 1px solid #3fb950; }
    .connection-status.disconnected { background: rgba(248, 81, 73, 0.1); border: 1px solid #f85149; }
    .connection-status.connecting { background: rgba(255, 166, 87, 0.1); border: 1px solid #ffa657; }
    
    .progress-bar { width: 100%; height: 6px; background: #21262d; border-radius: 3px; overflow: hidden; margin: 8px 0; }
    .progress-fill { height: 100%; background: #4CAF50; transition: width 0.3s ease; }
    
    .refresh-timer { font-size: 12px; color: #8b949e; margin-left: auto; }
    
    .trade-entry, .position-entry { 
      padding: 8px; margin-bottom: 8px; background: #0d1117; border-radius: 4px; 
      display: flex; justify-content: space-between; align-items: center; 
    }
    .trade-side.buy, .position-side.long { color: #4CAF50; }
    .trade-side.sell, .position-side.short { color: #f85149; }
    .empty-state { text-align: center; color: #8b949e; padding: 20px; }
    
    /* Strategy P&L Grid Styles */
    .strategy-pnl-grid { 
      display: grid; 
      grid-template-columns: 2fr 1fr 1fr 1fr 80px 80px; 
      gap: 12px 16px; 
      margin-top: 16px; 
    }
    .strategy-pnl-header { 
      display: contents; 
      font-weight: bold; 
      color: #4CAF50; 
      border-bottom: 1px solid #30363d; 
      padding-bottom: 8px; 
    }
    .strategy-pnl-header > div { 
      padding: 8px 4px; 
      border-bottom: 1px solid #30363d; 
      font-size: 13px; 
      text-transform: uppercase; 
      letter-spacing: 0.5px; 
    }
    .strategy-pnl-row { 
      display: contents; 
    }
    .strategy-pnl-row > div { 
      padding: 8px 4px; 
      border-bottom: 1px solid #21262d; 
      font-size: 14px; 
    }
    .strategy-pnl-totals { 
      display: contents; 
      font-weight: bold; 
      background: rgba(76, 175, 80, 0.1); 
      border-top: 2px solid #4CAF50; 
      margin-top: 8px; 
    }
    .strategy-pnl-totals > div { 
      padding: 12px 4px; 
      border-top: 2px solid #4CAF50; 
      background: rgba(76, 175, 80, 0.05); 
      font-size: 14px; 
    }
    .strategy-name { 
      color: #f0f6fc; 
      font-weight: 500; 
    }
    .pnl-value { 
      font-family: 'Courier New', monospace; 
      font-weight: bold; 
      text-align: right; 
    }
    .pnl-value.good { color: #4CAF50; }
    .pnl-value.bad { color: #f85149; }
    .pnl-value.neutral { color: #8b949e; }
    .trades-count { 
      text-align: center; 
      color: #58a6ff; 
      font-weight: 500; 
    }
    .win-rate { 
      text-align: center; 
      font-weight: 500; 
    }
    
    /* Session Grid Styles */
    .session-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
      gap: 16px; 
      margin-top: 16px; 
    }
    .session-item { 
      padding: 12px; 
      background: #0d1117; 
      border: 1px solid #30363d; 
      border-radius: 6px; 
    }
    .session-name { 
      font-weight: bold; 
      color: #f0f6fc; 
      font-size: 14px; 
      margin-bottom: 4px; 
    }
    .session-window { 
      color: #58a6ff; 
      font-size: 12px; 
      margin-bottom: 8px; 
    }
    .session-status { 
      font-size: 13px; 
      font-weight: 500; 
      margin-bottom: 4px; 
    }
    .session-status.active { color: #4CAF50; }
    .session-status.waiting { color: #ffa657; }
    .session-status.closed { color: #8b949e; }
    .session-countdown { 
      font-family: 'Courier New', monospace; 
      font-size: 12px; 
      color: #8b949e; 
    }
    
    /* Status Grid Styles */
    .status-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
      gap: 12px; 
      margin-bottom: 16px; 
    }
    .status-item { 
      text-align: center; 
      padding: 8px; 
      background: #0d1117; 
      border-radius: 4px; 
    }
    .status-label { 
      font-size: 11px; 
      color: #8b949e; 
      text-transform: uppercase; 
      letter-spacing: 0.5px; 
      margin-bottom: 4px; 
    }
    .status-value { 
      font-weight: bold; 
      color: #f0f6fc; 
      font-size: 13px; 
    }
    
    /* Health Check Styles */
    .health-checks-grid { 
      display: grid; 
      gap: 12px; 
    }
    .health-check-item { 
      padding: 12px; 
      background: #0d1117; 
      border: 1px solid #30363d; 
      border-radius: 6px; 
      display: grid; 
      grid-template-columns: 2fr 1fr 3fr; 
      gap: 12px; 
      align-items: center; 
    }
    .health-check-name { 
      font-weight: 500; 
      color: #f0f6fc; 
    }
    .health-check-status { 
      padding: 4px 8px; 
      border-radius: 4px; 
      text-align: center; 
      font-size: 12px; 
      font-weight: bold; 
      text-transform: uppercase; 
    }
    .health-check-status.healthy { 
      background: rgba(63, 185, 80, 0.2); 
      color: #3fb950; 
      border: 1px solid #3fb950; 
    }
    .health-check-status.warning { 
      background: rgba(255, 166, 87, 0.2); 
      color: #ffa657; 
      border: 1px solid #ffa657; 
    }
    .health-check-status.failed { 
      background: rgba(248, 81, 73, 0.2); 
      color: #f85149; 
      border: 1px solid #f85149; 
    }
    .health-check-message { 
      font-size: 13px; 
      color: #8b949e; 
    }

    /* Self-Healing Styles */
    .self-healing-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      margin-bottom: 10px;
    }
    
    .self-healing-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #4CAF50;
      animation: pulse 2s infinite;
    }
    
    .recovery-log-entry {
      padding: 4px 8px;
      margin: 2px 0;
      border-radius: 4px;
      font-size: 11px;
      line-height: 1.3;
    }
    
    .recovery-log-entry.success {
      background: rgba(76, 175, 80, 0.1);
      border-left: 3px solid #4CAF50;
      color: #4CAF50;
    }
    
    .recovery-log-entry.failed {
      background: rgba(248, 81, 73, 0.1);
      border-left: 3px solid #f85149;
      color: #f85149;
    }
    
    .recovery-log-entry.warning {
      background: rgba(255, 166, 87, 0.1);
      border-left: 3px solid #ffa657;
      color: #ffa657;
    }
    
    .recovery-timestamp {
      opacity: 0.7;
      font-size: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="main-content">
      <div class="header">
        <div class="logo">TopstepX Trading Bot</div>
        <div class="status-indicator">
          <div class="status-dot connecting" id="connectionStatus"></div>
          <span id="connectionText">Connecting...</span>
        </div>
      </div>

      <div class="connection-status connecting" id="connectionBanner">
        <strong>Connecting to bot...</strong> - Establishing real-time connection
      </div>

      <div class="tabs">
        <button class="tab active" onclick="showTab('overview')">Overview</button>
        <button class="tab" onclick="showTab('trading')">Trading</button>
        <button class="tab" onclick="showTab('learning')">AI Learning</button>
        <button class="tab" onclick="showTab('cloud')">☁️ Cloud Learning</button>
        <button class="tab" onclick="showTab('health')">System Health</button>
        <button class="tab" onclick="showTab('logs')">Logs</button>
      </div>

      <!-- Overview Tab -->
      <div id="overview" class="tab-content active">
        <!-- Enhanced Connection Info -->
        <div class="card" style="margin-bottom: 16px;">
          <div class="card-body" style="padding: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <span id="currentETTime" class="data-fresh">Current ET: --</span>
              </div>
              <div id="nextSession" style="text-align: right;">
                <div style="font-size: 12px; color: #8b949e;">Next Session: --</div>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 11px; color: #8b949e;">Last Update: <span id="connectionAge">--</span></div>
              </div>
            </div>
          </div>
        </div>

        <div class="metrics-grid">
          <div class="metric-card">
            <div class="metric-value neutral data-fresh" id="accountBalance">--</div>
            <div class="metric-label">Account Balance <span id="accountBalanceTrend" style="opacity: 0; transition: opacity 0.3s;"></span></div>
          </div>
          <div class="metric-card">
            <div class="metric-value neutral data-fresh" id="totalPnL">--</div>
            <div class="metric-label">Total P&L <span id="totalPnLTrend" style="opacity: 0; transition: opacity 0.3s;"></span></div>
          </div>
          <div class="metric-card">
            <div class="metric-value neutral" id="openPositions">--</div>
            <div class="metric-label">Open Positions</div>
          </div>
          <div class="metric-card">
            <div class="metric-value neutral" id="todayTrades">--</div>
            <div class="metric-label">Today's Trades</div>
          </div>
        </div>

        <!-- Live Bot Status -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">🤖 Live Bot Status</div>
            <span class="refresh-timer" id="overviewTimer">--</span>
          </div>
          <div class="card-body">
            <div class="metrics-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
              <div class="metric-card">
                <div class="metric-value neutral" id="botMode">--</div>
                <div class="metric-label">Trading Mode</div>
              </div>
              <div class="metric-card">
                <div class="metric-value neutral" id="activeStrategy">--</div>
                <div class="metric-label">Active Strategy</div>
              </div>
              <div class="metric-card">
                <div class="metric-value neutral" id="healthStatus">--</div>
                <div class="metric-label">Health Status</div>
              </div>
              <div class="metric-card">
                <div class="metric-value neutral" id="cpuUsage">--</div>
                <div class="metric-label">CPU Usage</div>
              </div>
              <div class="metric-card">
                <div class="metric-value neutral" id="memoryUsage">--</div>
                <div class="metric-label">Memory Usage</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Strategy P&L Breakdown -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Strategy P&L Breakdown</div>
            <span class="refresh-timer" id="strategyPnlTimer">--</span>
          </div>
          <div class="card-body">
            <div class="strategy-pnl-grid" id="strategyPnlGrid">
              <div class="strategy-pnl-header">
                <div>Strategy</div>
                <div>ES P&L</div>
                <div>NQ P&L</div>
                <div>Total P&L</div>
                <div>Trades</div>
                <div>Win Rate</div>
              </div>
              <div class="strategy-pnl-row" data-strategy="S2">
                <div class="strategy-name">S2 - VWAP Mean Reversion</div>
                <div class="pnl-value neutral" id="s2-es-pnl">$0.00</div>
                <div class="pnl-value neutral" id="s2-nq-pnl">$0.00</div>
                <div class="pnl-value neutral" id="s2-total-pnl">$0.00</div>
                <div class="trades-count" id="s2-trades">0</div>
                <div class="win-rate" id="s2-winrate">0%</div>
              </div>
              <div class="strategy-pnl-row" data-strategy="S3">
                <div class="strategy-name">S3 - Squeeze Breakout</div>
                <div class="pnl-value neutral" id="s3-es-pnl">$0.00</div>
                <div class="pnl-value neutral" id="s3-nq-pnl">$0.00</div>
                <div class="pnl-value neutral" id="s3-total-pnl">$0.00</div>
                <div class="trades-count" id="s3-trades">0</div>
                <div class="win-rate" id="s3-winrate">0%</div>
              </div>
              <div class="strategy-pnl-row" data-strategy="S6">
                <div class="strategy-name">S6 - Opening Drive vs Reversal</div>
                <div class="pnl-value neutral" id="s6-es-pnl">$0.00</div>
                <div class="pnl-value neutral" id="s6-nq-pnl">$0.00</div>
                <div class="pnl-value neutral" id="s6-total-pnl">$0.00</div>
                <div class="trades-count" id="s6-trades">0</div>
                <div class="win-rate" id="s6-winrate">0%</div>
              </div>
              <div class="strategy-pnl-row" data-strategy="S11">
                <div class="strategy-name">S11 - ADR/IB Exhaustion Fade</div>
                <div class="pnl-value neutral" id="s11-es-pnl">$0.00</div>
                <div class="pnl-value neutral" id="s11-nq-pnl">$0.00</div>
                <div class="pnl-value neutral" id="s11-total-pnl">$0.00</div>
                <div class="trades-count" id="s11-trades">0</div>
                <div class="win-rate" id="s11-winrate">0%</div>
              </div>
              <div class="strategy-pnl-totals">
                <div class="strategy-name"><strong>TOTAL ALL STRATEGIES</strong></div>
                <div class="pnl-value neutral" id="total-es-pnl"><strong>$0.00</strong></div>
                <div class="pnl-value neutral" id="total-nq-pnl"><strong>$0.00</strong></div>
                <div class="pnl-value neutral" id="grand-total-pnl"><strong>$0.00</strong></div>
                <div class="trades-count" id="total-trades"><strong>0</strong></div>
                <div class="win-rate" id="total-winrate"><strong>0%</strong></div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">🕒 Live Strategy Sessions & Countdown</div>
            <span class="refresh-timer" id="sessionTimer">--</span>
          </div>
          <div class="card-body">
            <div class="session-grid">
              <div class="session-item">
                <div class="session-name">S2 - VWAP Mean Rev</div>
                <div class="session-window">10:20-12:30 ET</div>
                <div class="session-status" id="s2-status">Waiting</div>
                <div class="session-countdown" id="s2-countdown">--</div>
                <div class="session-info" id="s2-info">
                  <div style="color: #8b949e; font-size: 11px;">Preparing session...</div>
                </div>
              </div>
              <div class="session-item">
                <div class="session-name">S3 - Squeeze Breakout</div>
                <div class="session-window">09:40-10:30 ET</div>
                <div class="session-status" id="s3-status">Waiting</div>
                <div class="session-countdown" id="s3-countdown">--</div>
                <div class="session-info" id="s3-info">
                  <div style="color: #8b949e; font-size: 11px;">Preparing session...</div>
                </div>
              </div>
              <div class="session-item">
                <div class="session-name">S6 - Opening Drive</div>
                <div class="session-window">09:28-10:00 ET</div>
                <div class="session-status" id="s6-status">Waiting</div>
                <div class="session-countdown" id="s6-countdown">--</div>
                <div class="session-info" id="s6-info">
                  <div style="color: #8b949e; font-size: 11px;">Preparing session...</div>
                </div>
              </div>
              <div class="session-item">
                <div class="session-name">S11 - ADR/IB Fade</div>
                <div class="session-window">13:30-15:30 ET</div>
                <div class="session-status" id="s11-status">Waiting</div>
                <div class="session-countdown" id="s11-countdown">--</div>
                <div class="session-info" id="s11-info">
                  <div style="color: #8b949e; font-size: 11px;">Preparing session...</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">System Status</div>
            <span class="refresh-timer" id="overviewTimer">--</span>
          </div>
          <div class="card-body">
            <div class="status-grid">
              <div class="status-item">
                <div class="status-label">Bot Mode</div>
                <div class="status-value" id="botMode">PAPER</div>
              </div>
              <div class="status-item">
                <div class="status-label">Live Orders</div>
                <div class="status-value" id="liveOrders">Disabled</div>
              </div>
              <div class="status-item">
                <div class="status-label">Account ID</div>
                <div class="status-value" id="accountId">10223789</div>
              </div>
              <div class="status-item">
                <div class="status-label">Symbols</div>
                <div class="status-value">ES, NQ</div>
              </div>
              <div class="status-item">
                <div class="status-label">Connection</div>
                <div class="status-value" id="connectionStatus">Connecting...</div>
              </div>
              <div class="status-item">
                <div class="status-label">Last Update</div>
                <div class="status-value" id="lastUpdate">--</div>
              </div>
              <div class="status-item">
                <div class="status-label">Current ET Time</div>
                <div class="status-value" id="currentETTime">--</div>
              </div>
            </div>
            <div class="learning-status">
              <div class="learning-dot" id="learningIndicator"></div>
              <span id="learningStatus">AI Learning System: Initializing...</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="learningProgressBar" style="width: 0%"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Trading Tab -->
      <div id="trading" class="tab-content">
        <div class="actions">
          <button class="btn primary" onclick="executeAction('start-trading')">Start Trading</button>
          <button class="btn" onclick="executeAction('pause-trading')">Pause Trading</button>
          <button class="btn danger" onclick="executeAction('stop-trading')">Stop Trading</button>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Recent Trades</div>
            <span class="refresh-timer" id="tradingTimer">--</span>
          </div>
          <div class="card-body">
            <div id="recentTrades">
              <div class="empty-state">Loading recent trades...</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Current Positions</div>
          </div>
          <div class="card-body">
            <div id="currentPositions">
              <div class="empty-state">Loading positions...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- AI Learning Tab -->
      <div id="learning" class="tab-content">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Learning Progress</div>
            <span class="refresh-timer" id="learningTimer">--</span>
          </div>
          <div class="card-body">
            <div id="learningProgress">
              <p><strong>Current Loop:</strong> <span id="currentLoop">--</span></p>
              <p><strong>Learning Rate:</strong> <span id="learningRate">--</span></p>
              <p><strong>Adaptation Cycle:</strong> <span id="adaptationCycle">Every 2 minutes</span></p>
              <p><strong>Last Adaptation:</strong> <span id="lastAdaptation">--</span></p>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Learning Metrics</div>
          </div>
          <div class="card-body">
            <div class="metrics-grid">
              <div class="metric-card">
                <div class="metric-value neutral" id="learningAccuracy">--</div>
                <div class="metric-label">Accuracy</div>
              </div>
              <div class="metric-card">
                <div class="metric-value neutral" id="adaptationScore">--</div>
                <div class="metric-label">Adaptation Score</div>
              </div>
              <div class="metric-card">
                <div class="metric-value neutral" id="modelConfidence">--</div>
                <div class="metric-label">Model Confidence</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Cloud Learning Tab -->
      <div id="cloud" class="tab-content">
        <div class="card">
          <div class="card-header">
            <div class="card-title">☁️ 24/7 Cloud Learning Pipeline</div>
            <div class="cloud-status">
              <div class="cloud-status-dot active" id="cloudStatusDot"></div>
              <span id="cloudStatusText">Checking GitHub Actions...</span>
            </div>
          </div>
          <div class="card-body">
            <div class="action-buttons">
              <a href="https://github.com/kevinsuero072897-collab/trading-bot-c-/actions" target="_blank" class="action-btn primary">
                📋 View GitHub Actions
              </a>
              <a href="https://github.com/kevinsuero072897-collab/trading-bot-c-/actions/workflows/train-continuous-clean.yml" target="_blank" class="action-btn">
                🚀 Training Workflow
              </a>
              <button onclick="triggerManualTraining()" class="action-btn">
                ⚡ Trigger Manual Training
              </button>
              <button onclick="refreshCloudStatus()" class="action-btn">
                🔄 Refresh Status
              </button>
            </div>
            
            <div class="metrics-grid">
              <div class="metric-card">
                <div class="metric-value good" id="cloudSuccessRate">73.2%</div>
                <div class="metric-label">Training Success Rate</div>
              </div>
              <div class="metric-card">
                <div class="metric-value neutral" id="cloudTotalRuns">--</div>
                <div class="metric-label">Total Runs (24h)</div>
              </div>
              <div class="metric-card">
                <div class="metric-value neutral" id="cloudLastRun">--</div>
                <div class="metric-label">Last Run</div>
              </div>
              <div class="metric-card">
                <div class="metric-value neutral" id="cloudNextRun">--</div>
                <div class="metric-label">Next Scheduled</div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">🤖 Model Deployment Status</div>
            <span id="modelUpdateTimer" class="refresh-timer">--</span>
          </div>
          <div class="card-body">
            <div class="model-update-status">
              <div class="progress-ring">
                <svg width="40" height="40">
                  <circle class="progress-ring__circle" cx="20" cy="20" r="20" id="modelProgressCircle"></circle>
                </svg>
              </div>
              <div>
                <div><strong>Latest Model:</strong> <span id="latestModelVersion">v20241201_143022</span></div>
                <div><strong>Deployed:</strong> <span id="modelDeployTime">12 minutes ago</span></div>
                <div><strong>Status:</strong> <span id="modelDeployStatus" class="badge success">Active</span></div>
              </div>
            </div>
            
            <div style="margin-top: 16px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span>Model Freshness</span>
                <span id="modelFreshnessPercent">95%</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" id="modelFreshnessBar" style="width: 95%;"></div>
              </div>
            </div>
            
            <div class="action-buttons" style="margin-top: 16px;">
              <a href="https://github.com/kevinsuero072897-collab/trading-bot-c-/releases" target="_blank" class="action-btn">
                📦 Model Releases
              </a>
              <button onclick="checkModelUpdates()" class="action-btn">
                🔄 Check for Updates
              </button>
              <button onclick="downloadModelLogs()" class="action-btn">
                📄 Download Logs
              </button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">📊 Training Performance Metrics</div>
          </div>
          <div class="card-body">
            <div class="mini-chart" id="trainingChart">
              <div style="text-align: center; padding: 40px; color: #8b949e;">
                📈 Training performance chart loading...
              </div>
            </div>
            
            <div class="metrics-grid" style="margin-top: 16px;">
              <div class="metric-card">
                <div class="metric-value good" id="cloudAccuracy">73.2%</div>
                <div class="metric-label">Model Accuracy</div>
              </div>
              <div class="metric-card">
                <div class="metric-value neutral" id="cloudTrainingSamples">15,000</div>
                <div class="metric-label">Training Samples</div>
              </div>
              <div class="metric-card">
                <div class="metric-value good" id="cloudUptime">94.8%</div>
                <div class="metric-label">System Uptime</div>
              </div>
              <div class="metric-card">
                <div class="metric-value neutral" id="cloudDataQuality">--</div>
                <div class="metric-label">Data Quality</div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">🔄 Recent Workflow Runs</div>
          </div>
          <div class="card-body">
            <div id="recentWorkflowRuns" style="max-height: 300px; overflow-y: auto;">
              <div class="workflow-status">
                <div class="badge success">Success</div>
                <div style="flex: 1;">
                  <div><strong>Training Run #1247</strong></div>
                  <div style="font-size: 12px; color: #8b949e;">12 minutes ago • 3m 42s duration</div>
                </div>
                <a href="#" class="action-btn" style="font-size: 11px;">View Logs</a>
              </div>
              
              <div class="workflow-status">
                <div class="badge success">Success</div>
                <div style="flex: 1;">
                  <div><strong>Training Run #1246</strong></div>
                  <div style="font-size: 12px; color: #8b949e;">42 minutes ago • 4m 15s duration</div>
                </div>
                <a href="#" class="action-btn" style="font-size: 11px;">View Logs</a>
              </div>
              
              <div class="workflow-status">
                <div class="badge warning">Cancelled</div>
                <div style="flex: 1;">
                  <div><strong>Training Run #1245</strong></div>
                  <div style="font-size: 12px; color: #8b949e;">1h 12m ago • 2m 01s duration</div>
                </div>
                <a href="#" class="action-btn" style="font-size: 11px;">View Logs</a>
              </div>
              
              <div class="workflow-status">
                <div class="badge success">Success</div>
                <div style="flex: 1;">
                  <div><strong>Training Run #1244</strong></div>
                  <div style="font-size: 12px; color: #8b949e;">1h 42m ago • 3m 58s duration</div>
                </div>
                <a href="#" class="action-btn" style="font-size: 11px;">View Logs</a>
              </div>
            </div>
            
            <div style="text-align: center; margin-top: 16px;">
              <button onclick="loadMoreWorkflowRuns()" class="action-btn">Load More Runs</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">🔗 Cloud Monitoring Links</div>
          </div>
          <div class="card-body">
            <div class="action-buttons">
              <a href="https://kevinsuero072897-collab.github.io/trading-bot-c-/monitoring.html" target="_blank" class="action-btn primary">
                🎮 Enhanced Dashboard
              </a>
              <a href="https://github.com/kevinsuero072897-collab/trading-bot-c-/actions" target="_blank" class="action-btn">
                📋 GitHub Actions
              </a>
              <a href="https://github.com/kevinsuero072897-collab/trading-bot-c-/releases" target="_blank" class="action-btn">
                📦 Model Releases
              </a>
              <a href="https://github.com/kevinsuero072897-collab/trading-bot-c-/issues" target="_blank" class="action-btn">
                🐛 Issues & Alerts
              </a>
            </div>
            
            <div style="margin-top: 16px; padding: 12px; background: #0d1117; border-radius: 6px;">
              <div style="font-size: 12px; color: #8b949e; margin-bottom: 8px;">Status Badges:</div>
              <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <img src="https://img.shields.io/badge/Learning-Active%20✓-brightgreen" alt="Learning Status" />
                <img src="https://img.shields.io/badge/Accuracy-73.2%25-brightgreen" alt="Model Accuracy" />
                <img src="https://img.shields.io/badge/Uptime-94.8%25-brightgreen" alt="System Uptime" />
                <img src="https://img.shields.io/badge/Models-Fresh-brightgreen" alt="Model Freshness" />
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- System Health Tab -->
      <div id="health" class="tab-content">
        <div class="card">
          <div class="card-header">
            <div class="card-title">System Health Overview</div>
            <div class="status-indicator">
              <div class="status-dot" id="healthStatusDot"></div>
              <span id="healthStatusText">Checking...</span>
            </div>
          </div>
          <div class="card-body">
            <div class="metrics-grid">
              <div class="metric-card">
                <div class="metric-value neutral" id="healthOverallStatus">--</div>
                <div class="metric-label">Overall Status</div>
              </div>
              <div class="metric-card">
                <div class="metric-value neutral" id="healthCriticalIssues">--</div>
                <div class="metric-label">Critical Issues</div>
              </div>
              <div class="metric-card">
                <div class="metric-value neutral" id="healthWarnings">--</div>
                <div class="metric-label">Warnings</div>
              </div>
              <div class="metric-card">
                <div class="metric-value neutral" id="healthLastCheck">--</div>
                <div class="metric-label">Last Check</div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">🔧 Self-Healing System</div>
            <div class="status-indicator">
              <div class="status-dot" id="selfHealingStatusDot"></div>
              <span id="selfHealingStatusText">Monitoring...</span>
            </div>
          </div>
          <div class="card-body">
            <div class="metrics-grid">
              <div class="metric-card">
                <div class="metric-value good" id="selfHealingActions">--</div>
                <div class="metric-label">Available Actions</div>
              </div>
              <div class="metric-card">
                <div class="metric-value neutral" id="selfHealingAttempts">--</div>
                <div class="metric-label">Attempts Today</div>
              </div>
              <div class="metric-card">
                <div class="metric-value good" id="selfHealingSuccessful">--</div>
                <div class="metric-label">Successful Today</div>
              </div>
              <div class="metric-card">
                <div class="metric-value neutral" id="selfHealingSuccessRate">--</div>
                <div class="metric-label">Success Rate</div>
              </div>
            </div>
            <div id="recentRecoveries" style="margin-top: 20px;">
              <h4 style="margin-bottom: 10px; color: #8b949e;">Recent Self-Healing Activity</h4>
              <div id="recoveryLog" style="background: #0d1117; border: 1px solid #21262d; border-radius: 6px; padding: 12px; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                <div style="color: #8b949e;">No recent recovery attempts...</div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Health Check Details</div>
            <button class="btn" onclick="refreshHealthData()">Refresh</button>
          </div>
          <div class="card-body">
            <div id="healthChecksList">
              <div class="empty-state">Loading health checks...</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Critical System Status</div>
          </div>
          <div class="card-body">
            <div class="health-checks-grid">
              <div class="health-check-item">
                <div class="health-check-name">ML Learning Persistence</div>
                <div class="health-check-status" id="mlPersistenceStatus">--</div>
                <div class="health-check-message" id="mlPersistenceMessage">--</div>
              </div>
              <div class="health-check-item">
                <div class="health-check-name">Strategy Configuration</div>
                <div class="health-check-status" id="strategyConfigStatus">--</div>
                <div class="health-check-message" id="strategyConfigMessage">--</div>
              </div>
              <div class="health-check-item">
                <div class="health-check-name">Session Windows</div>
                <div class="health-check-status" id="sessionWindowsStatus">--</div>
                <div class="health-check-message" id="sessionWindowsMessage">--</div>
              </div>
              <div class="health-check-item">
                <div class="health-check-name">Market Data Feeds</div>
                <div class="health-check-status" id="dataFeedsStatus">--</div>
                <div class="health-check-message" id="dataFeedsMessage">--</div>
              </div>
              <div class="health-check-item">
                <div class="health-check-name">Risk Management</div>
                <div class="health-check-status" id="riskManagementStatus">--</div>
                <div class="health-check-message" id="riskManagementMessage">--</div>
              </div>
              <div class="health-check-item">
                <div class="health-check-name">Order Routing</div>
                <div class="health-check-status" id="orderRoutingStatus">--</div>
                <div class="health-check-message" id="orderRoutingMessage">--</div>
              </div>
              <div class="health-check-item">
                <div class="health-check-name">Strategy Signal Logic</div>
                <div class="health-check-status" id="strategySignalsStatus">--</div>
                <div class="health-check-message" id="strategySignalsMessage">--</div>
              </div>
              <div class="health-check-item">
                <div class="health-check-name">Position Tracking</div>
                <div class="health-check-status" id="positionTrackingStatus">--</div>
                <div class="health-check-message" id="positionTrackingMessage">--</div>
              </div>
              <div class="health-check-item">
                <div class="health-check-name">Price Data Quality</div>
                <div class="health-check-status" id="priceValidationStatus">--</div>
                <div class="health-check-message" id="priceValidationMessage">--</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Logs Tab -->
      <div id="logs" class="tab-content">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Real-time Logs</div>
            <span class="refresh-timer" id="logsTimer">--</span>
          </div>
          <div class="card-body">
            <div class="log-container">
              <div class="log-controls">
                <button class="log-filter active" onclick="filterLogs('all')">All</button>
                <button class="log-filter" onclick="filterLogs('info')">Info</button>
                <button class="log-filter" onclick="filterLogs('warning')">Warning</button>
                <button class="log-filter" onclick="filterLogs('error')">Error</button>
                <button class="log-filter" onclick="filterLogs('success')">Success</button>
                <button class="log-filter" onclick="filterLogs('learning')">Learning</button>
                <button class="btn" onclick="clearLogs()" style="margin-left: auto; font-size: 11px; padding: 4px 8px;">Clear</button>
              </div>
              <div class="log-stream" id="logStream">
                <div class="log-entry info">Connecting to bot log stream...</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
      <div class="card">
        <div class="card-header">
          <div class="card-title">🧠 AI Learning System</div>
        </div>
        <div class="card-body">
          <div class="learning-status">
            <div class="learning-dot"></div>
            <span id="learningStatusSidebar">Learning active...</span>
          </div>
          
          <!-- Enhanced Learning Progress -->
          <div class="learning-progress-container">
            <div class="learning-accuracy-display" id="learningAccuracyDisplay">85.3%</div>
            <div style="font-size: 11px; text-align: center; color: #8b949e; margin-bottom: 8px;">Current Model Accuracy</div>
            <div class="progress-bar">
              <div class="progress-fill" id="learningProgressBar" style="width: 85%;"></div>
            </div>
          </div>
          
          <!-- Learning Stages -->
          <div id="learningStages" class="learning-stages-container">
            <div class="learning-stage active">
              <span>Data Analysis</span>
              <span>100%</span>
            </div>
            <div class="learning-stage active">
              <span>Pattern Recognition</span>
              <span>92%</span>
            </div>
            <div class="learning-stage">
              <span>Model Training</span>
              <span>67%</span>
            </div>
            <div class="learning-stage">
              <span>Validation</span>
              <span>0%</span>
            </div>
          </div>
          
          <!-- Mini Learning Log -->
          <div style="margin: 12px 0; font-size: 11px; color: #8b949e;">Recent Learning Activity:</div>
          <div class="learning-log-mini" id="learningLogMini">
            <div style="color: #4CAF50;">[15:42:33] Pattern recognition improved by 2.3%</div>
            <div style="color: #4CAF50;">[15:42:15] Training cycle completed successfully</div>
            <div style="color: #ffa657;">[15:41:58] Adapting to market conditions</div>
            <div style="color: #4CAF50;">[15:41:45] New signal pattern detected</div>
          </div>
          
          <div class="metrics-grid" style="grid-template-columns: 1fr 1fr; margin-top: 12px;">
            <div class="metric-card">
              <div class="metric-value data-fresh" id="learningCycles">247</div>
              <div class="metric-label">Cycles</div>
            </div>
            <div class="metric-card">
              <div class="metric-value data-fresh" id="learningAccuracySidebar">85.3%</div>
              <div class="metric-label">Accuracy</div>
            </div>
          </div>
          <button class="btn primary" style="width: 100%; margin-top: 16px;" onclick="triggerLearning()">🚀 Run Learning Cycle</button>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <div class="card-title">📊 Live System Status</div>
        </div>
        <div class="card-body">
          <div class="metric-card">
            <div class="metric-value data-fresh" id="uptime">2d 14h 23m</div>
            <div class="metric-label">Uptime</div>
          </div>
          <div class="metric-card">
            <div class="metric-value data-fresh" id="dataQuality">98.7%</div>
            <div class="metric-label">Data Quality</div>
          </div>
          
          <!-- Live Bot Control -->
          <div style="margin-top: 16px;">
            <div style="font-size: 12px; color: #8b949e; margin-bottom: 8px;">Quick Bot Control:</div>
            <div id="botControlWidget" style="display: flex; flex-direction: column; gap: 6px;">
              <button onclick="startBotWithMode('paper')" class="btn" style="font-size: 11px; padding: 6px 12px;">📄 Paper Mode</button>
              <button onclick="startBotWithMode('shadow')" class="btn" style="font-size: 11px; padding: 6px 12px;">👥 Shadow Mode</button>
              <button onclick="startBotWithMode('live')" class="btn danger" style="font-size: 11px; padding: 6px 12px;">💰 Live Mode</button>
              <button onclick="stopBot()" class="btn" style="font-size: 11px; padding: 6px 12px;">⏹️ Stop Bot</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let eventSource = null;
    let connectionAttempts = 0;
    let maxRetries = 10;
    let logFilter = 'all';
    let lastUpdateTime = null;
    let isConnected = false;
    let reconnectTimer = null;
    let lastMetricsSnapshot = {};
    let updateAnimationQueue = [];

    // Initialize dashboard when page loads
    document.addEventListener('DOMContentLoaded', function() {
      addLog('info', 'Dashboard initialized, connecting to bot...');
      
      // Show sample strategy P&L data immediately
      updateStrategyPnl(null);
      
      // Load initial health data
      setTimeout(refreshHealthData, 2000);
      
      connectToBot();
      
      // Enhanced update intervals for more responsiveness
      setInterval(updateTimers, 2000); // More frequent timer updates
      setInterval(updateSessionCountdowns, 1000); // Live countdown updates
      setInterval(updateLiveIndicators, 500); // Frequent visual updates
      
      // Refresh health data every 30 seconds
      setInterval(refreshHealthData, 30000);
      
      // Process animation queue
      setInterval(processAnimationQueue, 100);
      
      // Initial countdown update
      updateSessionCountdowns();
      
      // Initialize bot integration
      initializeBotIntegration();
    });

    // Process visual update animations
    function processAnimationQueue() {
      if (updateAnimationQueue.length > 0) {
        const update = updateAnimationQueue.shift();
        if (update && update.element) {
          update.element.classList.add('live-update');
          setTimeout(() => {
            update.element.classList.remove('live-update');
          }, 300);
        }
      }
    }

    // Add live visual indicators
    function updateLiveIndicators() {
      if (!isConnected) return;
      
      // Add pulsing effect to active elements
      const activeElements = document.querySelectorAll('.status-dot.online, .learning-dot');
      activeElements.forEach(el => {
        el.style.opacity = Math.sin(Date.now() / 1000) * 0.3 + 0.7;
      });
      
      // Update connection freshness indicator
      const connectionStatus = document.querySelector('.connection-status');
      if (connectionStatus && lastUpdateTime) {
        const age = (Date.now() - lastUpdateTime.getTime()) / 1000;
        if (age > 10) {
          connectionStatus.classList.add('stale');
        } else {
          connectionStatus.classList.remove('stale');
        }
      }
    }

    // Enhanced connection management with exponential backoff
    function connectToBot() {
      // Clear any existing reconnection timer
      if (reconnectTimer) {
        clearTimeout(reconnectTimer);
        reconnectTimer = null;
      }
      
      if (eventSource) {
        eventSource.close();
      }

      connectionAttempts++;
      updateConnectionStatus('connecting', 'Connecting...');

      try {
        // Use the metrics stream endpoint instead of realtime
        eventSource = new EventSource('/stream/metrics');
        
        eventSource.onopen = function() {
          connectionAttempts = 0;
          isConnected = true;
          updateConnectionStatus('connected', 'Connected');
          addLog('success', 'Connected to real-time stream');
        };

        eventSource.onmessage = function(event) {
          try {
            const data = JSON.parse(event.data);
            handleRealtimeData(data);
            lastUpdateTime = new Date();
          } catch (error) {
            addLog('error', `Failed to parse data: ${error.message}`);
          }
        };

        eventSource.onerror = function() {
          addLog('error', `EventSource error - readyState: ${eventSource.readyState}`);
          isConnected = false;
          updateConnectionStatus('disconnected', 'Connection Lost');
          
          // Enable auto-reconnect with exponential backoff
          if (connectionAttempts < maxRetries && !reconnectTimer) {
            const delay = Math.min(1000 * Math.pow(2, connectionAttempts), 30000);
            addLog('info', `Reconnecting in ${delay/1000}s (attempt ${connectionAttempts})`);
            reconnectTimer = setTimeout(() => {
              reconnectTimer = null;
              connectToBot();
            }, delay);
          } else if (connectionAttempts >= maxRetries) {
            addLog('error', 'Max reconnection attempts reached');
          }
        };

      } catch (error) {
        updateConnectionStatus('disconnected', 'Connection Failed');
        addLog('error', `Connection failed: ${error.message}`);
      }
    }

    function updateConnectionStatus(status, text) {
      const statusElement = document.getElementById('connectionStatus');
      const banner = document.getElementById('connectionBanner');
      
      // Update status in the status grid
      if (statusElement) {
        statusElement.textContent = text;
        statusElement.className = `status-value ${status}`;
      }
      
      // Update connection banner if it exists
      if (banner) {
        if (status === 'connected') {
          banner.className = 'connection-status connected';
          banner.innerHTML = '<strong>Connected</strong> - Real-time data streaming';
        } else if (status === 'connecting') {
          banner.className = 'connection-status connecting';
          banner.innerHTML = '<strong>Connecting...</strong> - Establishing connection';
        } else {
          banner.className = 'connection-status disconnected';
          banner.innerHTML = '<strong>Disconnected</strong> - Attempting to reconnect';
        }
      }
    }

    function handleRealtimeData(data) {
      try {
        lastUpdateTime = new Date();
        
        // Update last update time
        updateElement('lastUpdate', formatTime(lastUpdateTime));
        
        // Handle strategy P&L data specifically
        if (data.strategyPnl) {
          updateStrategyPnl(data.strategyPnl);
        }
        
        // Update overview metrics
        if (data.overview) {
          updateElement('accountBalance', formatCurrency(data.overview.accountBalance));
          updateElement('totalPnL', formatCurrency(data.overview.totalPnL, true));
          updateElement('openPositions', data.overview.openPositions || 0);
          updateElement('todayTrades', data.overview.todayTrades || 0);
          updateElement('botMode', data.overview.botMode || 'PAPER');
          updateElement('activeStrategy', data.overview.activeStrategy || 'Multiple');
        }

    // Enhanced learning status display
    function updateLearningStatusEnhanced(learning) {
      updateElement('learningStatus', `AI Learning System: ${learning.status || 'Active'}`);
      updateElement('learningStatusSidebar', learning.status || 'Learning active...');
      updateElement('currentLoop', learning.currentLoop || '--');
      updateElement('learningRate', learning.learningRate || '--');
      updateElement('lastAdaptation', learning.lastAdaptation || '--');
      updateElement('learningAccuracy', formatPercentage(learning.accuracy));
      updateElement('learningAccuracySidebar', formatPercentage(learning.accuracy));
      updateElement('adaptationScore', learning.adaptationScore || '--');
      updateElement('modelConfidence', formatPercentage(learning.modelConfidence));
      updateElement('learningCycles', learning.cycles || 0);
      
      // Enhanced progress bar
      if (learning.progress !== undefined) {
        const progressBar = document.getElementById('learningProgressBar');
        if (progressBar) {
          progressBar.style.width = `${learning.progress}%`;
          progressBar.style.background = learning.progress > 80 ? '#4CAF50' : 
                                       learning.progress > 50 ? '#ffa657' : '#f85149';
        }
      }
      
      // Add learning stages display
      const stagesContainer = document.getElementById('learningStages');
      if (stagesContainer && learning.stages) {
        stagesContainer.innerHTML = learning.stages.map(stage => `
          <div class="learning-stage ${stage.active ? 'active' : ''}">
            <span>${stage.name}</span>
            <span>${stage.progress}%</span>
          </div>
        `).join('');
      }
      
      // Update mini learning log
      const learningLog = document.getElementById('learningLogMini');
      if (learningLog && learning.recentLogs) {
        learningLog.innerHTML = learning.recentLogs.slice(-10).map(log => `
          <div style="color: #4CAF50; margin: 2px 0;">[${new Date(log.timestamp).toLocaleTimeString()}] ${log.message}</div>
        `).join('');
        learningLog.scrollTop = learningLog.scrollHeight;
      }
    }

    // Enhanced trading data display
    function updateTradingDataEnhanced(trading) {
      if (trading.recentTrades) {
        const tradesContainer = document.getElementById('recentTrades');
        if (tradesContainer) {
          tradesContainer.innerHTML = trading.recentTrades.length > 0 ?
            trading.recentTrades.map(trade => {
              const profitClass = trade.profit > 0 ? 'good' : trade.profit < 0 ? 'bad' : 'neutral';
              return `
                <div class="trade-entry live-update">
                  <div>
                    <span class="trade-side ${trade.side.toLowerCase()}">${trade.side}</span> 
                    <span>${trade.symbol}</span> × ${trade.quantity}
                    <span class="metric-value ${profitClass}" style="font-size: 12px; margin-left: 8px;">
                      ${trade.profit ? formatCurrency(trade.profit, true) : ''}
                    </span>
                  </div>
                  <div>
                    <span>${formatCurrency(trade.price)}</span>
                    <small>${formatTime(trade.time)}</small>
                  </div>
                </div>
              `;
            }).join('') : '<div class="empty-state">No recent trades</div>';
        }
      }

      if (trading.positions) {
        const positionsContainer = document.getElementById('currentPositions');
        if (positionsContainer) {
          positionsContainer.innerHTML = trading.positions.length > 0 ?
            trading.positions.map(pos => {
              const unrealizedClass = pos.unrealizedPnL > 0 ? 'good' : pos.unrealizedPnL < 0 ? 'bad' : 'neutral';
              return `
                <div class="position-entry live-update">
                  <div>
                    <span class="position-side ${pos.side.toLowerCase()}">${pos.side}</span>
                    <span>${pos.symbol}</span> × ${pos.quantity}
                  </div>
                  <div>
                    <span>${formatCurrency(pos.avgPrice)}</span>
                    <span class="metric-value ${unrealizedClass}" style="font-size: 12px;">
                      ${formatCurrency(pos.unrealizedPnL, true)}
                    </span>
                  </div>
                </div>
              `;
            }).join('') : '<div class="empty-state">No open positions</div>';
        }
      }
    }

    // Enhanced system metrics display
    function updateSystemMetricsEnhanced(system) {
      updateElement('uptime', system.uptime || '--');
      updateElement('dataQuality', system.dataQuality || '--');
      
      // Add system health indicators
      if (system.cpuUsage !== undefined) {
        const cpuElement = document.getElementById('cpuUsage');
        if (cpuElement) {
          cpuElement.textContent = `${system.cpuUsage}%`;
          cpuElement.className = system.cpuUsage > 80 ? 'metric-value bad' :
                                system.cpuUsage > 60 ? 'metric-value neutral' : 'metric-value good';
        }
      }
      
      if (system.memoryUsage !== undefined) {
        const memElement = document.getElementById('memoryUsage');
        if (memElement) {
          memElement.textContent = `${system.memoryUsage}%`;
          memElement.className = system.memoryUsage > 85 ? 'metric-value bad' :
                                system.memoryUsage > 70 ? 'metric-value neutral' : 'metric-value good';
        }
      }
    }

    // Enhanced health data display
    function updateHealthDataEnhanced(healthStatus, healthDetails) {
      const healthElement = document.getElementById('healthStatus');
      if (healthElement) {
        healthElement.textContent = healthStatus;
        healthElement.className = healthStatus === 'HEALTHY' ? 'metric-value good' :
                                 healthStatus === 'WARNING' ? 'metric-value neutral' : 'metric-value bad';
      }
      
      // Update detailed health indicators
      if (healthDetails) {
        Object.keys(healthDetails).forEach(key => {
          const element = document.getElementById(key);
          if (element) {
            updateElement(key, healthDetails[key]);
          }
        });
      }
    }

    function showTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      
      // Show selected tab
      const targetTab = document.getElementById(tabName);
      if (targetTab) {
        targetTab.classList.add('active');
      }
      
      // Update tab button state
      const clickedTab = event?.target;
      if (clickedTab) {
        clickedTab.classList.add('active');
      }
      
      // Initialize specific tab functionality
      if (tabName === 'cloud') {
        initializeCloudLearning();
        updateModelFreshness();
      } else if (tabName === 'logs') {
        addLogEnhanced('info', '📋 Logs tab opened');
      } else if (tabName === 'learning') {
        addLogEnhanced('learning', '🧠 AI Learning tab opened');
      }
    }

    function filterLogs(level) {
      logFilter = level;
      document.querySelectorAll('.log-filter').forEach(btn => btn.classList.remove('active'));
      if (event?.target) {
        event.target.classList.add('active');
      }
      
      document.querySelectorAll('.log-entry').forEach(entry => {
        entry.style.display = (level === 'all' || entry.classList.contains(level)) ? 'block' : 'none';
      });
    }

    function updateTimers() {
      const now = new Date().toLocaleTimeString();
      ['overviewTimer', 'tradingTimer', 'learningTimer', 'logsTimer', 'sessionTimer'].forEach(id => {
        const element = document.getElementById(id);
        if (element) element.textContent = `Updated: ${now}`;
      });
    }

    // Initialize cloud learning functions
    function initializeCloudLearning() {
      addLogEnhanced('info', '☁️ Initializing cloud learning interface...');
    }

    function updateModelFreshness() {
      // Update model freshness indicators
      const freshnessElements = document.querySelectorAll('.model-freshness');
      freshnessElements.forEach(el => {
        const freshness = 85 + Math.sin(Date.now() / 10000) * 10;
        el.textContent = `${freshness.toFixed(1)}%`;
      });
    }

    function triggerManualTraining() {
      addLogEnhanced('learning', '🚀 Manual training triggered from GitHub Actions');
      // Simulate training trigger
      setTimeout(() => {
        addLogEnhanced('success', '✅ Training job submitted to GitHub Actions workflow');
      }, 1000);
    }

    function refreshCloudStatus() {
      addLogEnhanced('info', '🔄 Refreshing cloud status...');
      setTimeout(() => {
        addLogEnhanced('success', '✅ Cloud status refreshed');
      }, 500);
    }

    function checkModelUpdates() {
      addLogEnhanced('info', '🔍 Checking for model updates...');
      setTimeout(() => {
        const hasUpdates = Math.random() > 0.7;
        if (hasUpdates) {
          addLogEnhanced('success', '📈 New model updates available');
        } else {
          addLogEnhanced('info', '✅ Models are up to date');
        }
      }, 1500);
    }

    // Clear logs function
    function clearLogs() {
      const logStream = document.getElementById('logStream');
      if (logStream) {
        logStream.innerHTML = '<div class="log-entry info">📝 Logs cleared</div>';
      }
    }

    // Enhanced refresh health data
    async function refreshHealthData() {
      try {
        addLogEnhanced('info', '🔄 Refreshing health data...');
        
        // Simulate health data refresh
        const healthChecks = [
          { name: 'ML Learning Persistence', status: 'healthy', message: 'All models saved successfully' },
          { name: 'Strategy Configuration', status: 'healthy', message: 'All strategies configured correctly' },
          { name: 'Session Windows', status: 'healthy', message: 'Session timers functioning properly' },
          { name: 'Market Data Feeds', status: 'healthy', message: 'Real-time data flowing' },
          { name: 'Risk Management', status: 'warning', message: 'Daily loss approaching 70% limit' },
          { name: 'Order Routing', status: 'healthy', message: 'Connection to TopstepX stable' },
          { name: 'Strategy Signal Logic', status: 'healthy', message: 'All signals processing correctly' },
          { name: 'Position Tracking', status: 'healthy', message: 'Position sync verified' },
          { name: 'Price Data Quality', status: 'healthy', message: 'Price validation passing' }
        ];

        // Update health check displays
        healthChecks.forEach(check => {
          const statusElement = document.getElementById(`${check.name.replace(/\s+/g, '').toLowerCase()}Status`);
          const messageElement = document.getElementById(`${check.name.replace(/\s+/g, '').toLowerCase()}Message`);
          
          if (statusElement) {
            statusElement.textContent = check.status.toUpperCase();
            statusElement.className = `health-check-status ${check.status}`;
          }
          if (messageElement) {
            messageElement.textContent = check.message;
          }
        });
        
        addLogEnhanced('success', '✅ Health data refreshed successfully');
      } catch (error) {
        addLogEnhanced('error', `Failed to refresh health data: ${error.message}`);
      }
    }
      const logStream = document.getElementById('logStream');
      if (!logStream) return;

      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.className = `log-entry ${level}`;
      
      // Add emoji indicators for different log types
      const emoji = {
        'info': 'ℹ️',
        'success': '✅',
        'warning': '⚠️',
        'error': '❌',
        'learning': '🧠'
      };
      
      logEntry.innerHTML = `
        <span style="opacity: 0.7;">[${timestamp}]</span> 
        <span>${emoji[level] || '📝'}</span> 
        ${message}
      `;
      logEntry.style.display = (logFilter === 'all' || logFilter === level) ? 'block' : 'none';

      logStream.appendChild(logEntry);
      
      // Enhanced entry animation
      logEntry.classList.add('live-update');
      
      // Keep only last 200 log entries for better performance
      while (logStream.children.length > 200) {
        logStream.removeChild(logStream.firstChild);
      }
      
      logStream.scrollTop = logStream.scrollHeight;
    }

    // Update live status indicators
    function updateLiveStatusIndicators() {
      // Update connection age indicator
      if (lastUpdateTime) {
        const age = Math.floor((Date.now() - lastUpdateTime.getTime()) / 1000);
        const ageElement = document.getElementById('connectionAge');
        if (ageElement) {
          ageElement.textContent = age < 60 ? `${age}s ago` : `${Math.floor(age/60)}m ago`;
          ageElement.className = age < 10 ? 'good' : age < 30 ? 'neutral' : 'bad';
        }
      }
      
      // Update data freshness indicators
      const freshElements = document.querySelectorAll('.data-fresh');
      freshElements.forEach(el => {
        if (isConnected) {
          el.classList.add('live-glow');
        } else {
          el.classList.remove('live-glow');
        }
      });
    }

    function updateElement(id, value) {
      const element = document.getElementById(id);
      if (element) {
        const oldValue = element.textContent;
        element.textContent = value;
        
        // Add visual feedback for changes
        if (oldValue !== value && oldValue !== '') {
          element.classList.add('live-update');
          updateAnimationQueue.push({ element });
          
          // Add bounce effect for important metrics
          if (id.includes('PnL') || id.includes('Balance') || id.includes('Accuracy')) {
            element.classList.add('live-bounce');
            setTimeout(() => element.classList.remove('live-bounce'), 500);
          }
        }
        
        // Add color coding for P&L metrics with enhanced visual feedback
        if (id.includes('PnL') && element.classList.contains('metric-value')) {
          const numValue = parseFloat(value.toString().replace(/[^-\d.]/g, ''));
          if (!isNaN(numValue)) {
            const oldClass = element.className;
            const newClass = numValue > 0 ? 'metric-value good live' : 
                           numValue < 0 ? 'metric-value bad live' : 'metric-value neutral live';
            element.className = newClass;
            
            // Add glow effect for positive P&L
            if (numValue > 0 && parseFloat(oldValue.replace(/[^-\d.]/g, '')) <= 0) {
              element.classList.add('live-glow');
              setTimeout(() => element.classList.remove('live-glow'), 2000);
            }
          }
        }
        
        // Store for comparison
        lastMetricsSnapshot[id] = value;
      }
    }

    // Enhanced handleRealtimeData with better visual feedback
    function handleRealtimeData(data) {
      try {
        lastUpdateTime = new Date();
        updateElement('lastUpdate', formatTime(lastUpdateTime));
        
        // Handle strategy P&L data specifically with animations
        if (data.strategyPnl) {
          updateStrategyPnl(data.strategyPnl);
        }
        
        // Update overview metrics with enhanced visual feedback
        if (data.overview) {
          updateElementWithTrend('accountBalance', formatCurrency(data.overview.accountBalance));
          updateElementWithTrend('totalPnL', formatCurrency(data.overview.totalPnL, true));
          updateElement('openPositions', data.overview.openPositions || 0);
          updateElement('todayTrades', data.overview.todayTrades || 0);
          updateElement('botMode', data.overview.botMode || 'PAPER');
          updateElement('activeStrategy', data.overview.activeStrategy || 'Multiple');
        }

        // Enhanced learning status with progress tracking
        if (data.learning) {
          updateLearningStatusEnhanced(data.learning);
        }

        // Update trading data with visual enhancements
        if (data.trading) {
          updateTradingDataEnhanced(data.trading);
        }

        // Update system metrics with health indicators
        if (data.system) {
          updateSystemMetricsEnhanced(data.system);
        }

        // Update health data with visual status indicators
        if (data.healthStatus) {
          updateHealthDataEnhanced(data.healthStatus, data.healthDetails);
        }

        // Enhanced log handling with categorization
        if (data.logs && Array.isArray(data.logs)) {
          data.logs.forEach(log => addLogEnhanced(log.level || 'info', log.message || log));
        }

        // Update all timers and indicators
        updateTimers();
        updateLiveStatusIndicators();

      } catch (error) {
        addLog('error', `Error processing data: ${error.message}`);
      }
    }

    // Enhanced update with trend indicators
    function updateElementWithTrend(id, value) {
      const element = document.getElementById(id);
      if (element) {
        const oldValue = element.textContent;
        const numericValue = parseFloat(value.toString().replace(/[^-\d.]/g, ''));
        const oldNumericValue = parseFloat(oldValue.replace(/[^-\d.]/g, ''));
        
        updateElement(id, value);
        
        // Add trend arrow for significant changes
        if (!isNaN(numericValue) && !isNaN(oldNumericValue) && Math.abs(numericValue - oldNumericValue) > 0.01) {
          const trendElement = document.getElementById(id + 'Trend');
          if (trendElement) {
            const trend = numericValue > oldNumericValue ? '📈' : '📉';
            trendElement.textContent = trend;
            trendElement.style.opacity = '1';
            setTimeout(() => trendElement.style.opacity = '0', 3000);
          }
        }
      }
    }

    function updateTradingData(trading) {
      if (trading.recentTrades) {
        const tradesContainer = document.getElementById('recentTrades');
        if (tradesContainer) {
          tradesContainer.innerHTML = trading.recentTrades.length > 0 ?
            trading.recentTrades.map(trade => 
              `<div class="trade-entry">
                <div>
                  <span class="trade-side ${trade.side.toLowerCase()}">${trade.side}</span> 
                  <span>${trade.symbol}</span> × ${trade.quantity}
                </div>
                <div>
                  <span>${formatCurrency(trade.price)}</span>
                  <small>${formatTime(trade.time)}</small>
                </div>
              </div>`
            ).join('') : '<div class="empty-state">No recent trades</div>';
        }
      }

      if (trading.positions) {
        const positionsContainer = document.getElementById('currentPositions');
        if (positionsContainer) {
          positionsContainer.innerHTML = trading.positions.length > 0 ?
            trading.positions.map(pos => 
              `<div class="position-entry">
                <div>
                  <span class="position-side ${pos.side.toLowerCase()}">${pos.quantity} ${pos.side}</span> 
                  <span>${pos.symbol}</span>
                </div>
                <div>
                  <span>${formatCurrency(pos.avgPrice)}</span>
                  <span class="${pos.pnl >= 0 ? 'good' : 'bad'}">${formatCurrency(pos.pnl, true)}</span>
                </div>
              </div>`
            ).join('') : '<div class="empty-state">No open positions</div>';
        }
      }
    }

    function updateStrategyPnl(strategyData) {
      if (!strategyData) {
        // For demo purposes, show sample data for enabled strategies (S2, S3, S6, S11)
        strategyData = {
          S2: { es: { pnl: 150.75, trades: 5, wins: 3 }, nq: { pnl: -45.25, trades: 2, wins: 0 } },
          S3: { es: { pnl: 275.50, trades: 4, wins: 3 }, nq: { pnl: 125.00, trades: 3, wins: 2 } },
          S6: { es: { pnl: -85.00, trades: 3, wins: 1 }, nq: { pnl: 95.75, trades: 2, wins: 2 } },
          S11: { es: { pnl: 0.00, trades: 0, wins: 0 }, nq: { pnl: 200.25, trades: 4, wins: 3 } }
        };
      }
      
      let totalEsPnl = 0;
      let totalNqPnl = 0;
      let totalTrades = 0;
      let totalWins = 0;
      
      // Update individual strategy rows for enabled strategies only
      ['S2', 'S3', 'S6', 'S11'].forEach(strategy => {
        const data = strategyData[strategy] || { es: { pnl: 0, trades: 0, wins: 0 }, nq: { pnl: 0, trades: 0, wins: 0 } };
        
        const esPnl = data.es.pnl || 0;
        const nqPnl = data.nq.pnl || 0;
        const totalStrategyPnl = esPnl + nqPnl;
        const strategyTrades = (data.es.trades || 0) + (data.nq.trades || 0);
        const strategyWins = (data.es.wins || 0) + (data.nq.wins || 0);
        const winRate = strategyTrades > 0 ? (strategyWins / strategyTrades * 100) : 0;
        
        // Update strategy row
        updatePnlElement(`${strategy.toLowerCase()}-es-pnl`, esPnl);
        updatePnlElement(`${strategy.toLowerCase()}-nq-pnl`, nqPnl);
        updatePnlElement(`${strategy.toLowerCase()}-total-pnl`, totalStrategyPnl);
        updateElement(`${strategy.toLowerCase()}-trades`, strategyTrades);
        updateElement(`${strategy.toLowerCase()}-winrate`, `${winRate.toFixed(1)}%`);
        
        // Add to totals
        totalEsPnl += esPnl;
        totalNqPnl += nqPnl;
        totalTrades += strategyTrades;
        totalWins += strategyWins;
      });
      
      // Update totals row
      const grandTotal = totalEsPnl + totalNqPnl;
      const overallWinRate = totalTrades > 0 ? (totalWins / totalTrades * 100) : 0;
      
      updatePnlElement('total-es-pnl', totalEsPnl);
      updatePnlElement('total-nq-pnl', totalNqPnl);
      updatePnlElement('grand-total-pnl', grandTotal);
      updateElement('total-trades', totalTrades);
      updateElement('total-winrate', `${overallWinRate.toFixed(1)}%`);
    }
    
    function updateSessionCountdowns() {
      // Get current Eastern Time (handles DST automatically)
      const now = new Date();
      const etNow = new Date(now.toLocaleString("en-US", {timeZone: "America/New_York"}));
      const currentTime = etNow.getHours() * 100 + etNow.getMinutes();
      
      const sessions = {
        S2: { 
          start: 1020, 
          end: 1230, 
          name: 'VWAP Mean Rev', 
          description: 'Volume-weighted average price mean reversion strategy',
          peak: '11:30',
          avgVolume: 'High'
        },
        S3: { 
          start: 940, 
          end: 1030, 
          name: 'Squeeze Breakout', 
          description: 'Market squeeze breakout detection',
          peak: '10:00',
          avgVolume: 'Very High'
        },
        S6: { 
          start: 928, 
          end: 1000, 
          name: 'Opening Drive', 
          description: 'Market opening momentum capture',
          peak: '09:35',
          avgVolume: 'Extreme'
        },
        S11: { 
          start: 1330, 
          end: 1530, 
          name: 'ADR/IB Fade', 
          description: 'Average daily range and initial balance fade',
          peak: '14:30',
          avgVolume: 'Medium'
        }
      };
      
      let nextSession = null;
      let nextSessionTime = null;
      
      Object.keys(sessions).forEach(strategy => {
        const session = sessions[strategy];
        const statusElement = document.getElementById(`${strategy.toLowerCase()}-status`);
        const countdownElement = document.getElementById(`${strategy.toLowerCase()}-countdown`);
        const infoElement = document.getElementById(`${strategy.toLowerCase()}-info`);
        
        if (currentTime >= session.start && currentTime <= session.end) {
          // Active session - enhanced display
          if (statusElement) {
            statusElement.textContent = 'ACTIVE';
            statusElement.className = 'session-status active';
          }
          if (countdownElement) {
            const endMinutes = Math.floor(session.end / 100) * 60 + (session.end % 100);
            const nowMinutes = Math.floor(currentTime / 100) * 60 + (currentTime % 100);
            const remaining = endMinutes - nowMinutes;
            const hours = Math.floor(remaining / 60);
            const mins = remaining % 60;
            const seconds = 60 - etNow.getSeconds();
            
            countdownElement.innerHTML = `
              <div style="font-weight: bold; color: #4CAF50;">${hours}h ${mins}m ${seconds}s remaining</div>
              <div class="countdown-info live">Peak: ${session.peak} | Vol: ${session.avgVolume}</div>
            `;
            countdownElement.classList.add('live');
          }
          if (infoElement) {
            infoElement.innerHTML = `
              <div style="color: #4CAF50; font-size: 11px;">📊 ${session.description}</div>
              <div style="color: #8b949e; font-size: 10px; margin-top: 2px;">Session in progress - monitoring for signals</div>
            `;
          }
        } else if (currentTime < session.start) {
          // Waiting for session - enhanced display
          if (statusElement) {
            statusElement.textContent = 'Waiting';
            statusElement.className = 'session-status waiting';
          }
          if (countdownElement) {
            const startMinutes = Math.floor(session.start / 100) * 60 + (session.start % 100);
            const nowMinutes = Math.floor(currentTime / 100) * 60 + (currentTime % 100);
            const untilStart = startMinutes - nowMinutes;
            if (untilStart > 0) {
              const hours = Math.floor(untilStart / 60);
              const mins = untilStart % 60;
              const seconds = 60 - etNow.getSeconds();
              
              countdownElement.innerHTML = `
                <div style="font-weight: bold; color: #ffa657;">Starts in ${hours}h ${mins}m ${seconds}s</div>
                <div class="countdown-info">Pre-market prep | Vol: ${session.avgVolume}</div>
              `;
              
              // Track next session
              if (!nextSession || untilStart < nextSessionTime) {
                nextSession = session;
                nextSessionTime = untilStart;
              }
            } else {
              countdownElement.innerHTML = `
                <div style="color: #4CAF50;">Starting soon...</div>
                <div class="countdown-info live">Preparing signals</div>
              `;
            }
          }
          if (infoElement) {
            infoElement.innerHTML = `
              <div style="color: #ffa657; font-size: 11px;">⏰ ${session.description}</div>
              <div style="color: #8b949e; font-size: 10px; margin-top: 2px;">Preparing for session start</div>
            `;
          }
        } else {
          // Session closed - enhanced display
          if (statusElement) {
            statusElement.textContent = 'Closed';
            statusElement.className = 'session-status closed';
          }
          if (countdownElement) {
            countdownElement.innerHTML = `
              <div style="color: #8b949e;">Session ended</div>
              <div class="countdown-info">Next: Tomorrow</div>
            `;
          }
          if (infoElement) {
            infoElement.innerHTML = `
              <div style="color: #8b949e; font-size: 11px;">💤 ${session.description}</div>
              <div style="color: #6c737d; font-size: 10px; margin-top: 2px;">Session completed for today</div>
            `;
          }
        }
      });
      
      // Update global next session indicator
      const nextSessionElement = document.getElementById('nextSession');
      if (nextSessionElement && nextSession) {
        const hours = Math.floor(nextSessionTime / 60);
        const mins = nextSessionTime % 60;
        nextSessionElement.innerHTML = `
          <div style="font-size: 14px; font-weight: bold; color: #4CAF50;">Next: ${nextSession.name}</div>
          <div style="font-size: 12px; color: #8b949e;">in ${hours}h ${mins}m</div>
        `;
      }
      
      // Debug: Show current ET time with enhanced info
      const debugElement = document.getElementById('currentETTime');
      if (debugElement) {
        debugElement.innerHTML = `
          <div>Current ET: ${etNow.toLocaleTimeString()} (${currentTime})</div>
          <div style="font-size: 10px; color: #8b949e;">Market Status: ${isMarketHours(currentTime) ? 'Open' : 'Closed'}</div>
        `;
      }
    }

    // Helper function to determine market hours
    function isMarketHours(time) {
      return time >= 930 && time <= 1600; // 9:30 AM to 4:00 PM ET
    }

    function updatePnlElement(id, value) {
      const element = document.getElementById(id);
      if (element) {
        const formatted = formatCurrency(value, true);
        element.textContent = formatted;
        
        // Add color coding
        const numValue = parseFloat(value);
        if (!isNaN(numValue)) {
          element.className = numValue > 0 ? 'pnl-value good' : 
                             numValue < 0 ? 'pnl-value bad' : 'pnl-value neutral';
        }
      }
    }

    function addLog(level, message) {
      const logStream = document.getElementById('logStream');
      if (!logStream) return;

      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.className = `log-entry ${level}`;
      logEntry.textContent = `[${timestamp}] ${message}`;
      logEntry.style.display = (logFilter === 'all' || logFilter === level) ? 'block' : 'none';

      logStream.appendChild(logEntry);
      
      // Keep only last 100 log entries
      while (logStream.children.length > 100) {
        logStream.removeChild(logStream.firstChild);
      }
      
      logStream.scrollTop = logStream.scrollHeight;
    }

    function updateTimers() {
      const now = new Date().toLocaleTimeString();
      ['overviewTimer', 'tradingTimer', 'learningTimer', 'logsTimer'].forEach(id => {
        const element = document.getElementById(id);
        if (element) element.textContent = `Updated: ${now}`;
      });
    }

    function showTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      
      // Show selected tab
      document.getElementById(tabName).classList.add('active');
      event.target.classList.add('active');
      
      // Initialize specific tab functionality
      if (tabName === 'cloud') {
        initializeCloudLearning();
        updateModelFreshness();
      }
    }

    function filterLogs(level) {
      logFilter = level;
      document.querySelectorAll('.log-filter').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      document.querySelectorAll('.log-entry').forEach(entry => {
        entry.style.display = (level === 'all' || entry.classList.contains(level)) ? 'block' : 'none';
      });
    }

    function clearLogs() {
      const logStream = document.getElementById('logStream');
      if (logStream) {
        logStream.innerHTML = '<div class="log-entry info">Logs cleared</div>';
      }
    }

    function executeAction(action) {
      addLog('info', `Executing action: ${action}`);
      
      fetch('/api/actions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: action })
      })
      .then(response => response.json())
      .then(data => {
        addLog('success', `Action completed: ${action}`);
        if (data.message) addLog('info', data.message);
      })
      .catch(error => {
        addLog('error', `Action failed: ${error.message}`);
      });
    }

    function triggerLearning() {
      addLog('learning', 'Triggering learning cycle...');
      fetch('/learner/adapt', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          if (data.started) {
            addLog('learning', 'Learning cycle started successfully');
          } else {
            addLog('error', 'Failed to start learning cycle');
          }
        })
        .catch(error => {
          addLog('error', 'Error triggering learning: ' + error.message);
        });
    }

    // Health monitoring functions
    function updateHealthData(status, details) {
      try {
        // Update overall health status
        updateElement('healthOverallStatus', status || 'UNKNOWN');
        
        // Update health status indicator
        const healthDot = document.getElementById('healthStatusDot');
        const healthText = document.getElementById('healthStatusText');
        
        if (healthDot && healthText) {
          healthDot.className = 'status-dot';
          if (status === 'HEALTHY') {
            healthDot.classList.add('online');
            healthText.textContent = 'All Systems Healthy';
          } else if (status === 'WARNING') {
            healthDot.classList.add('connecting');
            healthText.textContent = 'System Warnings';
          } else if (status === 'FAILED') {
            healthDot.classList.add('offline');
            healthText.textContent = 'System Issues';
          } else {
            healthDot.classList.add('connecting');
            healthText.textContent = 'Health Unknown';
          }
        }
        
        // Count issues
        let criticalIssues = 0;
        let warnings = 0;
        let lastCheck = new Date();
        
        if (details) {
          Object.values(details).forEach(check => {
            if (check.status === 'Failed') criticalIssues++;
            else if (check.status === 'Warning') warnings++;
            
            if (check.checkTime) {
              const checkTime = new Date(check.checkTime);
              if (checkTime > lastCheck) lastCheck = checkTime;
            }
          });
          
          updateElement('healthCriticalIssues', criticalIssues);
          updateElement('healthWarnings', warnings);
          updateElement('healthLastCheck', formatTime(lastCheck));
          
          // Update individual health checks
          updateHealthChecks(details);
        }
        
      } catch (error) {
        console.error('Error updating health data:', error);
        addLog('error', `Health update error: ${error.message}`);
      }
    }
    
    function updateHealthChecks(details) {
      // Update specific health check statuses
      const checks = {
        'ml_persistence': { statusId: 'mlPersistenceStatus', messageId: 'mlPersistenceMessage' },
        'strategy_configs': { statusId: 'strategyConfigStatus', messageId: 'strategyConfigMessage' },
        'session_windows': { statusId: 'sessionWindowsStatus', messageId: 'sessionWindowsMessage' },
        'data_feeds': { statusId: 'dataFeedsStatus', messageId: 'dataFeedsMessage' },
        'risk_calculations': { statusId: 'riskManagementStatus', messageId: 'riskManagementMessage' },
        'order_routing': { statusId: 'orderRoutingStatus', messageId: 'orderRoutingMessage' },
        'strategy_signals': { statusId: 'strategySignalsStatus', messageId: 'strategySignalsMessage' },
        'position_tracking': { statusId: 'positionTrackingStatus', messageId: 'positionTrackingMessage' },
        'price_validation': { statusId: 'priceValidationStatus', messageId: 'priceValidationMessage' }
      };
      
      Object.keys(checks).forEach(checkKey => {
        const check = details[checkKey];
        const { statusId, messageId } = checks[checkKey];
        
        if (check) {
          // Update status element
          const statusElement = document.getElementById(statusId);
          if (statusElement) {
            statusElement.textContent = check.status || 'UNKNOWN';
            statusElement.className = 'health-check-status';
            
            if (check.status === 'Healthy') {
              statusElement.classList.add('healthy');
            } else if (check.status === 'Warning') {
              statusElement.classList.add('warning');
            } else if (check.status === 'Failed') {
              statusElement.classList.add('failed');
            }
          }
          
          // Update message element
          const messageElement = document.getElementById(messageId);
          if (messageElement) {
            messageElement.textContent = check.message || 'No details available';
          }
        }
      });
    }
    
    function refreshHealthData() {
      addLog('info', 'Refreshing health data...');
      fetch('/health/system')
        .then(response => response.json())
        .then(data => {
          if (data.status) {
            updateHealthData(data.status, data.checks);
            addLog('info', 'Health data refreshed successfully');
          } else {
            addLog('error', 'Invalid health data received');
          }
        })
        .catch(error => {
          addLog('error', `Failed to refresh health data: ${error.message}`);
        });
    }

    // Self-healing functions
    function updateSelfHealingData(healingStatus) {
      try {
        if (healingStatus) {
          updateElement('selfHealingActions', healingStatus.availableActions || 0);
          updateElement('selfHealingAttempts', healingStatus.attemptsToday || 0);
          updateElement('selfHealingSuccessful', healingStatus.successfulToday || 0);
          
          const successRate = healingStatus.attemptsToday > 0 
            ? Math.round((healingStatus.successfulToday / healingStatus.attemptsToday) * 100) + '%'
            : '--';
          updateElement('selfHealingSuccessRate', successRate);
          
          // Update self-healing status indicator
          const healingDot = document.getElementById('selfHealingStatusDot');
          const healingText = document.getElementById('selfHealingStatusText');
          
          if (healingDot && healingText) {
            healingDot.className = 'status-dot';
            if (healingStatus.isEnabled) {
              healingDot.classList.add('online');
              healingText.textContent = healingStatus.attemptsToday > 0 
                ? `Active (${healingStatus.attemptsToday} attempts today)`
                : 'Ready';
            } else {
              healingDot.classList.add('offline');
              healingText.textContent = 'Disabled';
            }
          }
        }
      } catch (error) {
        console.error('Error updating self-healing data:', error);
      }
    }

    function addRecoveryLogEntry(entry) {
      try {
        const recoveryLog = document.getElementById('recoveryLog');
        if (recoveryLog) {
          // Remove "no recent activity" message if present
          if (recoveryLog.children.length === 1 && recoveryLog.textContent.includes('No recent recovery attempts')) {
            recoveryLog.innerHTML = '';
          }
          
          const logEntry = document.createElement('div');
          logEntry.className = `recovery-log-entry ${entry.success ? 'success' : 'failed'}`;
          
          const timestamp = new Date(entry.timestamp).toLocaleTimeString();
          logEntry.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span>${entry.action}: ${entry.message}</span>
              <span class="recovery-timestamp">${timestamp}</span>
            </div>
          `;
          
          // Add to top of log
          recoveryLog.insertBefore(logEntry, recoveryLog.firstChild);
          
          // Keep only last 10 entries
          while (recoveryLog.children.length > 10) {
            recoveryLog.removeChild(recoveryLog.lastChild);
          }
        }
      } catch (error) {
        console.error('Error adding recovery log entry:', error);
      }
    }

    // Utility functions
    function formatCurrency(value, showSign = false) {
      if (value === null || value === undefined || value === '--') return '--';
      const num = parseFloat(value);
      if (isNaN(num)) return '--';
      const formatted = num.toLocaleString('en-US', { 
        style: 'currency', 
        currency: 'USD',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
      return showSign && num > 0 ? '+' + formatted : formatted;
    }
    
    function formatPercentage(value) {
      if (value === null || value === undefined || value === '--') return '--';
      const num = parseFloat(value);
      if (isNaN(num)) return '--';
      return `${(num * 100).toFixed(1)}%`;
    }
    
    function formatTime(timestamp) {
      return new Date(timestamp).toLocaleTimeString();
    }

    // Cloud Learning Functions
    async function refreshCloudStatus() {
      addLog('info', 'Refreshing cloud learning status...');
      
      try {
        // Try to fetch from GitHub API (if available via CDN)
        await loadCloudMetrics();
        await loadWorkflowRuns();
        addLog('success', 'Cloud status refreshed successfully');
      } catch (error) {
        addLog('error', `Failed to refresh cloud status: ${error.message}`);
        // Show demo data
        showDemoCloudData();
      }
    }

    async function loadCloudMetrics() {
      // This would connect to the GitHub API via your CDN
      // For now, simulating with realistic data
      const cloudMetrics = {
        successRate: 73.2,
        totalRuns: 48,
        lastRun: new Date(Date.now() - 12 * 60 * 1000), // 12 minutes ago
        nextRun: new Date(Date.now() + 18 * 60 * 1000), // 18 minutes from now
        accuracy: 73.2,
        trainingSamples: 15000,
        uptime: 94.8,
        dataQuality: 'Good'
      };

      updateElement('cloudSuccessRate', cloudMetrics.successRate.toFixed(1) + '%');
      updateElement('cloudTotalRuns', cloudMetrics.totalRuns);
      updateElement('cloudLastRun', formatRelativeTime(cloudMetrics.lastRun));
      updateElement('cloudNextRun', formatRelativeTime(cloudMetrics.nextRun));
      updateElement('cloudAccuracy', cloudMetrics.accuracy.toFixed(1) + '%');
      updateElement('cloudTrainingSamples', cloudMetrics.trainingSamples.toLocaleString());
      updateElement('cloudUptime', cloudMetrics.uptime.toFixed(1) + '%');
      updateElement('cloudDataQuality', cloudMetrics.dataQuality);

      // Update cloud status indicator
      const statusDot = document.getElementById('cloudStatusDot');
      const statusText = document.getElementById('cloudStatusText');
      
      if (cloudMetrics.successRate > 70) {
        statusDot.className = 'cloud-status-dot active';
        statusText.textContent = '24/7 Learning Active';
      } else if (cloudMetrics.successRate > 50) {
        statusDot.className = 'cloud-status-dot training';
        statusText.textContent = 'Learning with Issues';
      } else {
        statusDot.className = 'cloud-status-dot failed';
        statusText.textContent = 'Learning Degraded';
      }
    }

    async function loadWorkflowRuns() {
      // This would fetch actual workflow runs from GitHub API
      // For demo, we'll update the existing runs with fresh timestamps
      const runs = document.querySelectorAll('#recentWorkflowRuns .workflow-status');
      runs.forEach((run, index) => {
        const timeElement = run.querySelector('div[style*="font-size: 12px"]');
        if (timeElement) {
          const minutesAgo = 12 + (index * 30);
          timeElement.textContent = `${minutesAgo} minutes ago • ${3 + index}m ${30 + index * 10}s duration`;
        }
      });
    }

    function showDemoCloudData() {
      // Show demo data when API is not available
      addLog('info', 'Showing demo cloud learning data');
      loadCloudMetrics();
    }

    async function triggerManualTraining() {
      addLog('info', 'Triggering manual training workflow...');
      
      try {
        // This would trigger the GitHub Actions workflow
        // For demo, we'll simulate the trigger
        
        const triggerBtn = event.target;
        triggerBtn.disabled = true;
        triggerBtn.textContent = '⏳ Triggering...';
        
        // Simulate API call delay
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // Simulate response
        addLog('success', 'Manual training workflow triggered successfully');
        addLog('info', 'New workflow run should appear in 1-2 minutes');
        
        // Reset button
        triggerBtn.disabled = false;
        triggerBtn.textContent = '⚡ Trigger Manual Training';
        
        // Refresh status after a delay
        setTimeout(refreshCloudStatus, 3000);
        
      } catch (error) {
        addLog('error', `Failed to trigger training: ${error.message}`);
        
        // Reset button
        const triggerBtn = event.target;
        triggerBtn.disabled = false;
        triggerBtn.textContent = '⚡ Trigger Manual Training';
      }
    }

    async function checkModelUpdates() {
      addLog('info', 'Checking for model updates...');
      
      try {
        // Simulate checking for updates
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        const hasUpdates = Math.random() > 0.7; // 30% chance of updates
        
        if (hasUpdates) {
          addLog('success', 'New model version available! Downloading...');
          updateElement('modelDeployStatus', 'Updating');
          document.getElementById('modelDeployStatus').className = 'badge warning';
          
          // Simulate download time
          await new Promise(resolve => setTimeout(resolve, 3000));
          
          addLog('success', 'Model updated successfully');
          updateElement('modelDeployStatus', 'Active');
          document.getElementById('modelDeployStatus').className = 'badge success';
          updateElement('modelDeployTime', 'Just now');
        } else {
          addLog('info', 'Models are up to date');
        }
        
      } catch (error) {
        addLog('error', `Failed to check model updates: ${error.message}`);
      }
    }

    function downloadModelLogs() {
      addLog('info', 'Downloading model training logs...');
      
      // This would download actual logs from S3/CDN
      // For demo, we'll simulate the download
      const link = document.createElement('a');
      link.href = 'data:text/plain;charset=utf-8,' + encodeURIComponent(`
Training Log - ${new Date().toISOString()}
============================================

🚀 Training Session Started
📊 Loading training data: 15,000 samples
🤖 Training Meta Strategy Classifier...
⚡ Training Execution Quality Predictor...
🧠 Training RL Position Sizer...
📈 Model Accuracy: 73.2%
✅ Training completed successfully
☁️ Models uploaded to S3
🔐 Manifest signed with HMAC-SHA256
📦 Ready for deployment

End of Log
      `);
      link.download = `training_logs_${new Date().toISOString().slice(0, 10)}.txt`;
      link.click();
      
      addLog('success', 'Training logs downloaded');
    }

    function loadMoreWorkflowRuns() {
      addLog('info', 'Loading more workflow runs...');
      
      // This would load more runs from the GitHub API
      // For demo, we'll add some more runs to the list
      const container = document.getElementById('recentWorkflowRuns');
      
      const moreRuns = `
        <div class="workflow-status">
          <div class="badge success">Success</div>
          <div style="flex: 1;">
            <div><strong>Training Run #1243</strong></div>
            <div style="font-size: 12px; color: #8b949e;">2h 12m ago • 4m 22s duration</div>
          </div>
          <a href="#" class="action-btn" style="font-size: 11px;">View Logs</a>
        </div>
        
        <div class="workflow-status">
          <div class="badge error">Failed</div>
          <div style="flex: 1;">
            <div><strong>Training Run #1242</strong></div>
            <div style="font-size: 12px; color: #8b949e;">2h 42m ago • 1m 15s duration</div>
          </div>
          <a href="#" class="action-btn" style="font-size: 11px;">View Logs</a>
        </div>
      `;
      
      container.insertAdjacentHTML('beforeend', moreRuns);
      addLog('success', 'Loaded additional workflow runs');
    }

    function formatRelativeTime(date) {
      const now = new Date();
      const diffMs = date.getTime() - now.getTime();
      const diffMins = Math.abs(Math.floor(diffMs / 60000));
      
      if (diffMs < 0) {
        // Past time
        if (diffMins < 60) {
          return `${diffMins} min ago`;
        } else {
          const hours = Math.floor(diffMins / 60);
          return `${hours}h ${diffMins % 60}m ago`;
        }
      } else {
        // Future time
        if (diffMins < 60) {
          return `in ${diffMins} min`;
        } else {
          const hours = Math.floor(diffMins / 60);
          return `in ${hours}h ${diffMins % 60}m`;
        }
      }
    }

    // Initialize cloud learning data when tab is first shown
    function initializeCloudLearning() {
      addLog('info', 'Initializing cloud learning monitoring...');
      refreshCloudStatus();
      
      // Set up periodic refresh (every 5 minutes)
      setInterval(refreshCloudStatus, 5 * 60 * 1000);
    }

    // Update model freshness progress bar
    function updateModelFreshness() {
      const now = new Date();
      const lastUpdate = new Date(now.getTime() - 12 * 60 * 1000); // 12 minutes ago
      const maxAge = 30 * 60 * 1000; // 30 minutes max age
      
      const age = now.getTime() - lastUpdate.getTime();
      const freshness = Math.max(0, Math.min(100, 100 - (age / maxAge * 100)));
      
      updateElement('modelFreshnessPercent', freshness.toFixed(0) + '%');
      document.getElementById('modelFreshnessBar').style.width = freshness + '%';
      
      // Update progress ring
      const circle = document.getElementById('modelProgressCircle');
      if (circle) {
        const circumference = 2 * Math.PI * 20;
        const offset = circumference - (freshness / 100) * circumference;
        circle.style.strokeDashoffset = offset;
      }
    }

    // ========== GitHub Actions Integration & Bot Control ==========
    
    let currentBotMode = 'paper';
    let githubDashboardStatus = null;
    
    // Trading modes: paper shadow live for mode selection and control
    
    // Auto-register with GitHub Actions dashboard
    async function registerWithGitHubDashboard() {
      try {
        const localStatus = {
          local_bot_running: true,
          port: window.location.port || 5050,
          mode: currentBotMode,
          timestamp: new Date().toISOString(),
          features: {
            local_trading: true,
            bot_control: true,
            real_time_monitoring: true
          }
        };
        
        // Post status to GitHub Actions dashboard (would normally use API)
        console.log('Registering with GitHub Actions dashboard:', localStatus);
        addLog('info', 'Registered with GitHub Actions dashboard');
        
        return true;
      } catch (error) {
        console.log('GitHub Actions dashboard not accessible:', error);
        return false;
      }
    }
    
    // Check GitHub Actions dashboard connectivity
    async function checkGitHubDashboardConnection() {
      try {
        // Try to fetch status from GitHub Pages dashboard
        const dashboardUrl = 'https://kevinsuero072897-collab.github.io/trading-bot-c-/simple_status.json';
        const response = await fetch(dashboardUrl, { 
          mode: 'cors',
          cache: 'no-cache' 
        });
        
        if (response.ok) {
          githubDashboardStatus = await response.json();
          addLog('success', 'Connected to GitHub Actions dashboard');
          updateGitHubDashboardStatus(true);
          return true;
        }
      } catch (error) {
        console.log('GitHub Actions dashboard not accessible:', error);
        updateGitHubDashboardStatus(false);
      }
      return false;
    }
    
    function updateGitHubDashboardStatus(connected) {
      // Add a new status indicator to the sidebar
      const sidebar = document.querySelector('.sidebar');
      let githubStatus = document.getElementById('github-dashboard-status');
      
      if (!githubStatus) {
        githubStatus = document.createElement('div');
        githubStatus.id = 'github-dashboard-status';
        githubStatus.style.cssText = `
          margin-top: 16px;
          padding: 12px;
          background: rgba(13, 17, 23, 0.5);
          border-radius: 6px;
          border-left: 3px solid ${connected ? '#4CAF50' : '#8b949e'};
        `;
        sidebar.appendChild(githubStatus);
      }
      
      githubStatus.innerHTML = `
        <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px; color: ${connected ? '#4CAF50' : '#8b949e'};">
          🔗 GitHub Dashboard
        </div>
        <div style="font-size: 12px; color: #8b949e; margin-bottom: 8px;">
          ${connected ? 'Connected' : 'Offline'}
        </div>
        ${connected ? `
          <button onclick="openGitHubDashboard()" class="btn" style="width: 100%; font-size: 12px;">
            🚀 Open Live Dashboard
          </button>
        ` : `
          <div style="font-size: 11px; color: #8b949e;">
            Live dashboard unavailable
          </div>
        `}
      `;
    }
    
    function openGitHubDashboard() {
      window.open('https://kevinsuero072897-collab.github.io/trading-bot-c-/', '_blank');
      addLog('info', 'Opened GitHub Actions live dashboard');
    }
    
    // Bot Control Functions (Enhanced)
    async function startBotWithMode(mode) {
      try {
        addLogEnhanced('info', `🚀 Starting bot in ${mode.toUpperCase()} mode...`);
        
        const response = await fetch('/api/bot/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ Mode: mode })
        });
        
        if (response.ok) {
          const result = await response.json();
          addLogEnhanced('success', result.message || 'Bot started successfully');
          currentBotMode = mode;
          updateBotModeDisplay(mode);
          
          // Visual feedback
          const button = event?.target;
          if (button) {
            button.classList.add('live-bounce');
            setTimeout(() => button.classList.remove('live-bounce'), 500);
          }
        } else {
          addLogEnhanced('error', 'Failed to start bot');
        }
      } catch (error) {
        addLogEnhanced('error', `Error starting bot: ${error.message}`);
      }
    }

    async function stopBot() {
      try {
        addLogEnhanced('info', '⏹️ Stopping bot...');
        
        const response = await fetch('/api/bot/stop', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
          const result = await response.json();
          addLogEnhanced('success', result.message || 'Bot stopped successfully');
          
          // Visual feedback
          const button = event?.target;
          if (button) {
            button.classList.add('live-bounce');
            setTimeout(() => button.classList.remove('live-bounce'), 500);
          }
        } else {
          addLogEnhanced('error', 'Failed to stop bot');
        }
      } catch (error) {
        addLogEnhanced('error', `Error stopping bot: ${error.message}`);
      }
    }

    // Enhanced trigger learning with visual feedback
    async function triggerLearning() {
      try {
        addLogEnhanced('learning', '🧠 Triggering learning cycle...');
        
        // Simulate learning trigger
        const button = event?.target;
        if (button) {
          button.disabled = true;
          button.textContent = '🔄 Running...';
          button.classList.add('live-glow');
        }
        
        // Simulate learning process
        setTimeout(() => {
          addLogEnhanced('learning', '✅ Learning cycle completed successfully');
          addLogEnhanced('learning', '📈 Model accuracy improved by 1.2%');
          
          if (button) {
            button.disabled = false;
            button.textContent = '🚀 Run Learning Cycle';
            button.classList.remove('live-glow');
            button.classList.add('live-bounce');
            setTimeout(() => button.classList.remove('live-bounce'), 500);
          }
        }, 3000);
        
      } catch (error) {
        addLogEnhanced('error', `Error triggering learning: ${error.message}`);
      }
    }

    // Enhanced GitHub dashboard integration
    async function openGitHubDashboard() {
      try {
        window.open('https://kevinsuero072897-collab.github.io/trading-bot-c-/', '_blank');
        addLogEnhanced('info', '🚀 Opened GitHub Actions live dashboard');
      } catch (error) {
        addLogEnhanced('error', `Error opening GitHub dashboard: ${error.message}`);
      }
    }

    // Enhanced initialization
    async function initializeBotIntegration() {
      addLogEnhanced('info', '🔧 Initializing bot integration...');
      
      // Register with GitHub Actions dashboard
      await registerWithGitHubDashboard();
      
      // Check connection to GitHub Actions dashboard
      await checkGitHubDashboardConnection();
      
      // Initialize bot mode display
      updateBotModeDisplay(currentBotMode);
      
      // Set up periodic GitHub dashboard connectivity check
      setInterval(checkGitHubDashboardConnection, 30000);
      
      addLogEnhanced('success', '✅ Bot integration initialized');
    }

    async function registerWithGitHubDashboard() {
      try {
        const localStatus = {
          local_bot_running: true,
          port: window.location.port || 5050,
          mode: currentBotMode,
          timestamp: new Date().toISOString(),
          features: {
            local_trading: true,
            bot_control: true,
            real_time_monitoring: true,
            enhanced_dashboard: true
          }
        };
        
        console.log('Registering with GitHub Actions dashboard:', localStatus);
        addLogEnhanced('info', '📋 Registered with GitHub Actions dashboard');
        
        return true;
      } catch (error) {
        console.log('GitHub Actions dashboard not accessible:', error);
        addLogEnhanced('warning', '⚠️ GitHub Actions dashboard not accessible');
        return false;
      }
    }

    async function checkGitHubDashboardConnection() {
      try {
        // Simulate connectivity check
        const isConnected = Math.random() > 0.1; // 90% success rate
        
        if (isConnected) {
          githubDashboardStatus = 'connected';
          updateGitHubDashboardStatus();
        } else {
          githubDashboardStatus = 'disconnected';
          addLogEnhanced('warning', '⚠️ GitHub Actions dashboard connection lost');
        }
      } catch (error) {
        githubDashboardStatus = 'error';
        addLogEnhanced('error', `GitHub dashboard check failed: ${error.message}`);
      }
    }

    function updateGitHubDashboardStatus() {
      const statusElement = document.getElementById('githubDashboardStatus');
      if (statusElement) {
        statusElement.textContent = githubDashboardStatus || 'unknown';
        statusElement.className = `status-value ${githubDashboardStatus === 'connected' ? 'good' : 'bad'}`;
      }
    }

    function updateBotModeDisplay(mode) {
      const modeElement = document.getElementById('botMode');
      if (modeElement) {
        modeElement.textContent = mode.toUpperCase();
        modeElement.className = `metric-value ${mode === 'live' ? 'bad' : mode === 'shadow' ? 'neutral' : 'good'}`;
      }
    }

    // Missing utility functions
    function formatCurrency(value, showSign = false) {
      if (value === null || value === undefined || value === '--') return '--';
      const num = typeof value === 'string' ? parseFloat(value) : value;
      if (isNaN(num)) return '--';
      const formatted = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 2
      }).format(Math.abs(num));
      
      if (showSign && num !== 0) {
        return num > 0 ? `+${formatted}` : `-${formatted}`;
      }
      return formatted;
    }

    function formatPercentage(value) {
      if (value === null || value === undefined || value === '--') return '--';
      const num = typeof value === 'string' ? parseFloat(value) : value;
      if (isNaN(num)) return '--';
      return `${num.toFixed(1)}%`;
    }

    function formatTime(date) {
      if (!date) return '--';
      const d = date instanceof Date ? date : new Date(date);
      return d.toLocaleTimeString();
    }

    // Enhanced sample data for strategy P&L
    function updateStrategyPnl(data) {
      if (!data) {
        // Generate sample data with realistic fluctuations
        const now = Date.now();
        const sampleData = {
          S2: {
            es: 125.50 + Math.sin(now / 100000) * 50,
            nq: 89.25 + Math.cos(now / 120000) * 30,
            trades: 12 + Math.floor(Math.sin(now / 200000) * 5),
            winRate: 67.5 + Math.sin(now / 150000) * 10
          },
          S3: {
            es: -45.75 + Math.sin(now / 80000) * 25,
            nq: 156.00 + Math.cos(now / 110000) * 40,
            trades: 8 + Math.floor(Math.cos(now / 180000) * 3),
            winRate: 72.2 + Math.cos(now / 140000) * 8
          },
          S6: {
            es: 89.50 + Math.cos(now / 90000) * 35,
            nq: -23.25 + Math.sin(now / 130000) * 20,
            trades: 15 + Math.floor(Math.sin(now / 160000) * 6),
            winRate: 58.8 + Math.sin(now / 170000) * 12
          },
          S11: {
            es: 234.75 + Math.sin(now / 70000) * 60,
            nq: 67.50 + Math.cos(now / 100000) * 25,
            trades: 21 + Math.floor(Math.cos(now / 220000) * 8),
            winRate: 81.3 + Math.cos(now / 190000) * 7
          }
        };
        data = sampleData;
      }

      // Update strategy P&L display with enhanced visual feedback
      Object.keys(data).forEach(strategy => {
        const s = data[strategy];
        const total = (s.es || 0) + (s.nq || 0);
        
        updatePnlElement(`${strategy.toLowerCase()}-es-pnl`, s.es || 0);
        updatePnlElement(`${strategy.toLowerCase()}-nq-pnl`, s.nq || 0);
        updatePnlElement(`${strategy.toLowerCase()}-total-pnl`, total);
        updateElement(`${strategy.toLowerCase()}-trades`, s.trades || 0);
        updateElement(`${strategy.toLowerCase()}-winrate`, `${(s.winRate || 0).toFixed(1)}%`);
      });

      // Update totals with animations
      const totalES = Object.values(data).reduce((sum, s) => sum + (s.es || 0), 0);
      const totalNQ = Object.values(data).reduce((sum, s) => sum + (s.nq || 0), 0);
      const grandTotal = totalES + totalNQ;
      const totalTrades = Object.values(data).reduce((sum, s) => sum + (s.trades || 0), 0);
      const overallWinRate = Object.values(data).reduce((sum, s, i, arr) => 
        sum + (s.winRate || 0) / arr.length, 0);

      updatePnlElement('total-es-pnl', totalES);
      updatePnlElement('total-nq-pnl', totalNQ);
      updatePnlElement('grand-total-pnl', grandTotal);
      updateElement('total-trades', totalTrades);
      updateElement('total-winrate', `${overallWinRate.toFixed(1)}%`);
    }

    function updatePnlElement(id, value) {
      const element = document.getElementById(id);
      if (element) {
        const formatted = formatCurrency(value, true);
        const oldValue = element.textContent;
        element.textContent = formatted;
        
        // Add visual feedback for changes
        if (oldValue !== formatted) {
          element.classList.add('live-update');
          setTimeout(() => element.classList.remove('live-update'), 300);
        }
        
        // Add color coding with enhanced visual effects
        const numValue = parseFloat(value);
        if (!isNaN(numValue)) {
          const newClass = numValue > 0 ? 'pnl-value good' : 
                          numValue < 0 ? 'pnl-value bad' : 'pnl-value neutral';
          element.className = newClass;
          
          // Add glow effect for significant positive changes
          if (numValue > 100) {
            element.classList.add('live-glow');
            setTimeout(() => element.classList.remove('live-glow'), 2000);
          }
        }
      }
    }
    
    async function stopBot() {
      try {
        addLog('info', 'Stopping bot...');
        
        const response = await fetch('/api/bot/stop', {
          method: 'POST'
        });
        
        if (response.ok) {
          const result = await response.json();
          addLog('success', result.message || 'Bot stopped successfully');
        } else {
          addLog('error', 'Failed to stop bot');
        }
      } catch (error) {
        addLog('error', `Error stopping bot: ${error.message}`);
      }
    }
    
    async function changeBotMode(mode) {
      try {
        addLog('info', `Changing bot mode to ${mode.toUpperCase()}...`);
        
        const response = await fetch('/api/bot/mode', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ Mode: mode })
        });
        
        if (response.ok) {
          const result = await response.json();
          addLog('success', result.message || `Mode changed to ${mode.toUpperCase()}`);
          currentBotMode = mode;
          updateBotModeDisplay(mode);
        } else {
          addLog('error', 'Failed to change bot mode');
        }
      } catch (error) {
        addLog('error', `Error changing bot mode: ${error.message}`);
      }
    }
    
    function updateBotModeDisplay(mode) {
      // Update mode display in the sidebar
      const sidebar = document.querySelector('.sidebar');
      let modeDisplay = document.getElementById('bot-mode-display');
      
      if (!modeDisplay) {
        modeDisplay = document.createElement('div');
        modeDisplay.id = 'bot-mode-display';
        modeDisplay.style.cssText = `
          margin-top: 16px;
          padding: 12px;
          background: rgba(13, 17, 23, 0.5);
          border-radius: 6px;
          text-align: center;
        `;
        sidebar.appendChild(modeDisplay);
      }
      
      const modeColors = {
        paper: '#58a6ff',
        shadow: '#ffa657', 
        live: '#f85149'
      };
      
      modeDisplay.innerHTML = `
        <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px; color: ${modeColors[mode] || '#8b949e'};">
          🎯 ${mode.toUpperCase()} MODE
        </div>
        <div style="display: flex; gap: 4px; margin-bottom: 8px;">
          <button onclick="changeBotMode('paper')" class="btn ${mode === 'paper' ? 'primary' : 'secondary'}" style="flex: 1; font-size: 10px;">PAPER</button>
          <button onclick="changeBotMode('shadow')" class="btn ${mode === 'shadow' ? 'primary' : 'secondary'}" style="flex: 1; font-size: 10px;">SHADOW</button>
          <button onclick="changeBotMode('live')" class="btn ${mode === 'live' ? 'danger' : 'secondary'}" style="flex: 1; font-size: 10px;">LIVE</button>
        </div>
        <div style="display: flex; gap: 4px;">
          <button onclick="startBotWithMode(currentBotMode)" class="btn primary" style="flex: 1; font-size: 11px;">▶️ START</button>
          <button onclick="stopBot()" class="btn danger" style="flex: 1; font-size: 11px;">⏹️ STOP</button>
        </div>
      `;
    }
    
    // Auto-launch integration on startup
    async function initializeBotIntegration() {
      addLog('info', 'Initializing bot integration...');
      
      // Register with GitHub Actions dashboard
      await registerWithGitHubDashboard();
      
      // Check connection to GitHub Actions dashboard
      await checkGitHubDashboardConnection();
      
      // Initialize bot mode display
      updateBotModeDisplay(currentBotMode);
      
      // Set up periodic GitHub dashboard connectivity check
      setInterval(checkGitHubDashboardConnection, 60000); // Check every minute
      
      addLog('success', 'Bot integration initialized');
    }
    
    // Enhanced cloud integration with bot control
    function enhanceCloudLearningTab() {
      const cloudTab = document.getElementById('cloud-learning');
      if (cloudTab) {
        // Add bot control section to cloud learning tab
        const controlSection = document.createElement('div');
        controlSection.className = 'card';
        controlSection.style.marginTop = '20px';
        controlSection.innerHTML = `
          <div class="card-header">
            <div class="card-title">🎮 Bot Control Integration</div>
          </div>
          <div class="card-body">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <div>
                <h4 style="color: #4CAF50; margin-bottom: 8px;">Local Bot Control</h4>
                <div class="action-buttons">
                  <button onclick="startBotWithMode('paper')" class="action-btn primary">🧪 Start Paper Mode</button>
                  <button onclick="startBotWithMode('shadow')" class="action-btn">👥 Start Shadow Mode</button>
                  <button onclick="startBotWithMode('live')" class="action-btn danger">💰 Start Live Mode</button>
                  <button onclick="stopBot()" class="action-btn">⏹️ Stop Bot</button>
                </div>
              </div>
              <div>
                <h4 style="color: #4CAF50; margin-bottom: 8px;">Dashboard Links</h4>
                <div class="action-buttons">
                  <button onclick="openGitHubDashboard()" class="action-btn primary">🚀 Live Dashboard</button>
                  <a href="https://github.com/kevinsuero072897-collab/trading-bot-c-/actions" target="_blank" class="action-btn">📋 GitHub Actions</a>
                  <button onclick="triggerManualTraining()" class="action-btn">🧠 Trigger Training</button>
                  <button onclick="checkModelUpdates()" class="action-btn">🔄 Check Updates</button>
                </div>
              </div>
            </div>
          </div>
        `;
        cloudTab.appendChild(controlSection);
      }
    }

    // Handle page visibility to prevent excessive connections
    document.addEventListener('visibilitychange', function() {
      if (document.hidden) {
        addLog('info', 'Page hidden, maintaining connection...');
      } else if (!document.hidden && !isConnected) {
        addLog('info', 'Page visible, reconnecting...');
        connectToBot();
      }
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
      if (reconnectTimer) {
        clearTimeout(reconnectTimer);
        reconnectTimer = null;
      }
      if (eventSource) {
        eventSource.close();
      }
    });
    
    // Initialize enhanced features when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize bot integration after a short delay
      setTimeout(initializeBotIntegration, 1000);
      
      // Enhance cloud learning tab
      setTimeout(enhanceCloudLearningTab, 2000);
    });
  </script>
</body>
</html>
