<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>TopstepX Bot — Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root { --bg:#0f1217; --fg:#cbd5e1; --muted:#93a3b8; --good:#16a34a; --bad:#dc2626; --chip:#1f2733; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font:14px/1.4 ui-sans-serif,system-ui,Segoe UI,Roboto,Inter}
    .wrap{display:grid;grid-template-rows:auto 1fr auto;min-height:100%}
    .topbar{display:flex;gap:12px;align-items:center;padding:10px 14px;border-bottom:1px solid #1c2330}
    .chip{background:var(--chip);border-radius:12px;padding:6px 10px}
  .badge{border-radius:8px;padding:2px 6px;margin-left:6px;font-weight:600}
  .badge.paper{background:#0b2a1a;color:#a7f3d0;border:1px solid #14532d}
  .badge.live{background:#2a0d0d;color:#fecaca;border:1px solid #7f1d1d}
  .badge.shadow{background:#111827;color:#cbd5e1;border:1px solid #1f2937}
    .sp{opacity:.85}
    .pane{display:grid;grid-template-columns:1fr 280px;gap:8px;padding:8px;height:calc(100vh - 100px)}
    #chart{height:100%;border:1px solid #1c2330;border-radius:12px}
    .side{display:flex;flex-direction:column;gap:8px}
    .card{background:#0c1016;border:1px solid #1c2330;border-radius:12px;padding:10px}
    .k{color:var(--muted);min-width:120px;display:inline-block}
    .u{color:var(--muted)}
    .ok{color:var(--good)} .bad{color:var(--bad)}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .stream{height:220px;overflow:auto;font-size:12px;background:#0b0f14;border:1px solid #1c2330;border-radius:12px;padding:8px}
    .row{display:flex;justify-content:space-between}
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar mono" id="topbar">
    <span class="chip">acc <span id="acc">-</span></span>
  <span class="chip">mode <span id="mode">-</span></span>
    <span class="chip">r:<span id="r">0.00</span> u:<span id="u">0.00</span> d:<span id="d">0.00</span></span>
    <span class="chip">MDL <span id="mdl">0.00</span> rem <span id="rem">0.00</span></span>
    <span class="chip sp">U:<span id="uh">-</span> M:<span id="mh">-</span></span>
    <span class="chip sp" id="clock">--:--:--</span>
  <span class="chip sp" id="chip-allowed" title="Allowed strategies now" style="display:none"></span>
  <span class="chip sp" id="chip-learner" title="Learner status" style="display:none"></span>
  <span class="chip sp" id="badge-curfew" style="display:none;background:#3b1d00;color:#ffcc80">curfew</span>
  <span class="chip sp" id="badge-daypnl" style="display:none;background:#3b0014;color:#ff8aa1">dayPnL</span>
  </div>

  <div class="pane">
    <div id="chart"></div>
    <div class="side">
      <div class="card mono">
        <div class="row"><span class="k">Symbol</span><span id="sym">ES</span></div>
        <div class="row"><span class="k">Pos</span><span id="pos">FLAT</span></div>
        <div class="row"><span class="k">Avg</span><span id="avg">-</span></div>
        <div class="row"><span class="k">Mark</span><span id="mark">-</span></div>
        <div class="row"><span class="k">uPnL</span><span id="upnl">0.00</span></div>
        <div class="row"><span class="k">rPnL</span><span id="rpnl">0.00</span></div>
      </div>
      <div class="card">
        <div class="u">Events</div>
        <div class="stream mono" id="events"></div>
      </div>
      <div class="card" id="canary-card">
        <div class="u">Canary</div>
        <div class="mono" style="font-size:12px">
          <div id="canary-summary">loading…</div>
          <div id="canary-meta" class="u" style="margin-top:4px"></div>
          <div style="margin-top:6px; display:flex; gap:6px">
            <button id="btn-canary-reset" style="background:#1f2733;color:#cbd5e1;border:1px solid #2a3447;border-radius:8px;padding:4px 8px;cursor:pointer">Reset</button>
            <button id="btn-canary-clearbl" style="background:#1f2733;color:#cbd5e1;border:1px solid #2a3447;border-radius:8px;padding:4px 8px;cursor:pointer">Clear Blacklist</button>
          </div>
          <table id="canary-table" style="width:100%;border-collapse:collapse;margin-top:6px">
            <thead><tr><th style="text-align:left">Key</th><th style="text-align:left">Arm</th><th>Plays</th><th>Avg $</th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="u" style="margin-top:6px">Running</div>
          <table id="canary-running" style="width:100%;border-collapse:collapse">
            <thead><tr><th style="text-align:left">Root</th><th>Regime</th><th>Arm</th><th>Age</th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="u" style="margin-top:6px">Blacklist</div>
          <table id="canary-blacklist" style="width:100%;border-collapse:collapse">
            <thead><tr><th style="text-align:left">Key</th><th>Arm</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="card" id="retune-card">
        <div class="u">Retune</div>
        <div class="mono" style="font-size:12px">
          <div id="retune-summary">loading…</div>
          <table id="retune-table" style="width:100%;border-collapse:collapse;margin-top:6px">
            <thead><tr><th style="text-align:left">Root</th><th>Strat</th><th>Status</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="card" id="learners-card">
        <div class="u">Learners</div>
        <div class="mono" style="font-size:12px">
          <div id="learners-status">ready</div>
          <div style="margin-top:6px; display:flex; gap:6px">
            <button id="btn-launch-tuner" style="background:#1f2733;color:#cbd5e1;border:1px solid #2a3447;border-radius:8px;padding:4px 8px;cursor:pointer">Launch Tuner</button>
            <button id="btn-run-adapt" style="background:#1f2733;color:#cbd5e1;border:1px solid #2a3447;border-radius:8px;padding:4px 8px;cursor:pointer">Run Adaptive</button>
          </div>
        </div>
      </div>
      <div class="card" id="perf-card">
        <div class="u">Performance (last 10 days)</div>
        <div class="mono" style="font-size:12px">
          <div style="margin-bottom:6px;display:flex;gap:6px;align-items:center">
            <span id="perf-window">loading…</span>
            <button id="btn-perf-refresh" style="margin-left:auto;background:#1f2733;color:#cbd5e1;border:1px solid #2a3447;border-radius:8px;padding:4px 8px;cursor:pointer">Refresh</button>
          </div>
          <table id="perf-table" style="width:100%;border-collapse:collapse">
            <thead><tr><th style="text-align:left">Root</th><th style="text-align:right">Trades</th><th style="text-align:right">Net $</th><th style="text-align:left">By strategy</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="topbar sp mono">Tip: open another tab at <span class="u">/dashboard</span> for NQ (after you point the query to symbol=NQ).</div>
</div>

<script src="lib/lightweight-charts-loader.js"></script>
<script>
  // Wait for LightweightCharts to be available before initializing the chart.
  function whenLCReady(cb){
    if (window.LightweightCharts) return cb(window.LightweightCharts);
    const iv = setInterval(()=>{
      if (window.LightweightCharts){ clearInterval(iv); cb(window.LightweightCharts); }
    }, 50);
    // stop polling after 10s to avoid runaway
    setTimeout(()=> clearInterval(iv), 10000);
  }

  const symbol = new URLSearchParams(location.search).get("symbol") || "ES";
  const res = "1";

  const fmt2 = (n)=> (n==null? "-" : Number(n).toFixed(2));
  const set = (id, html)=> document.getElementById(id).innerHTML = html;
  const setPnL = (id, v)=> {
    let html = fmt2(v);
    if (v>0) html = `<span class="ok">+${fmt2(v)}</span>`;
    else if (v<0) html = `<span class="bad">${fmt2(v)}</span>`;
    set(id, html);
  };

  let chart, candles, volume;
  whenLCReady(({ createChart }) => {
    chart = createChart(document.getElementById("chart"), {
      layout: { background: { color: "#0f1217" }, textColor: "#B9C0D4" },
      grid: { vertLines: { color: "#1c2330" }, horzLines: { color: "#1c2330" } },
      timeScale: { timeVisible: true, secondsVisible: false },
      rightPriceScale: { borderVisible: false },
    });
    candles = chart.addCandlestickSeries();
    volume  = chart.addHistogramSeries({ priceFormat: { type: "volume" }, priceScaleId: "" });
    // Only load data and stream once the chart is ready
    loadHistory();
    connectStream();
  });

  async function loadHistory() {
    const now = Math.floor(Date.now()/1000), from = now - 3*24*60*60;
    const url = `/data/history?symbol=${symbol}&res=${res}&from=${from}&to=${now}`;
    const bars = await fetch(url).then(r=>r.json());
    candles.setData(bars.map(b=>({ time:b.t, open:b.o, high:b.h, low:b.l, close:b.c })));
    volume.setData(bars.map(b=>({ time:b.t, value:b.v })));
  }

  function connectStream() {
    const es = new EventSource(`/stream/realtime?symbol=${symbol}&res=${res}`);

  es.addEventListener("hello", () => {});

    es.onmessage = (e) => {
      const msg = JSON.parse(e.data);
      if (msg.type === "bar") {
        const b = msg.bar;
        candles.update({ time:b.t, open:b.o, high:b.h, low:b.l, close:b.c });
        volume.update({ time:b.t, value:b.v });
        set("mark", b.c);
      }
      if (msg.type === "metrics") {
        const m = msg.data;
  set("acc", m.accountId);
  // Mode badge (color-coded)
  const modeEl = document.getElementById('mode');
  modeEl.textContent = m.mode;
  modeEl.className = '';
  modeEl.classList.add('badge');
  if (m.mode === 'LIVE') modeEl.classList.add('live');
  else if (m.mode === 'PAPER') modeEl.classList.add('paper');
  else modeEl.classList.add('shadow');
        setPnL("r", m.realized); setPnL("u", m.unrealized); setPnL("d", m.day);
        set("mdl", fmt2(m.maxDailyLoss)); setPnL("rem", m.remaining);
        set("uh", m.userHub); set("mh", m.marketHub);
        set("clock", new Date(m.localTime).toLocaleTimeString());

        // allowed-now chip
        const ca = document.getElementById('chip-allowed');
        const allowed = (m.allowedNow||[]);
        if (allowed.length>0) { ca.style.display='inline-block'; ca.textContent = 'allowed ' + allowed.join(','); } else { ca.style.display='none'; }

        // learner chip
        const cl = document.getElementById('chip-learner');
        if (m.learnerOn) {
          const last = m.learnerLastRun? new Date(m.learnerLastRun).toLocaleTimeString() : '-';
          const note = m.learnerApplied==null? '' : (m.learnerApplied? 'applied' : 'skipped');
          cl.style.display='inline-block';
          cl.textContent = `learner ON · ${last}${note? ' · '+note:''}`;
        } else { cl.style.display='none'; }

  // badges
  const bc = document.getElementById("badge-curfew");
  const bd = document.getElementById("badge-daypnl");
  if (m.curfewNoNew) { bc.style.display = "inline-block"; } else { bc.style.display = "none"; }
  if (m.dayPnlNoNew) { bd.style.display = "inline-block"; } else { bd.style.display = "none"; }

        const ps = (m.positions||[]).find(p => p.sym === symbol);
        set("sym", symbol);
        if (!ps || ps.qty === 0) {
          set("pos", "FLAT"); set("avg","-"); set("mark","-");
          setPnL("upnl", 0); setPnL("rpnl", m.realized);
        } else {
          set("pos", (ps.qty > 0 ? "LONG " : "SHORT ") + Math.abs(ps.qty));
          set("avg", fmt2(ps.avg));
          set("mark", fmt2(ps.mark));
          setPnL("upnl", ps.uPnL);
          setPnL("rpnl", ps.rPnL);
        }
      }
      if (msg.type === "event") {
        const lvl = (msg.level||'info').toUpperCase();
        addEvent(`[${lvl}] ${msg.text}`);
      }
    };

    es.onerror = () => {
      addEvent("stream error — reconnecting…");
      es.close();
      setTimeout(connectStream, 1500);
    };
  }

  function addEvent(line) {
    const box = document.getElementById("events");
    const at = new Date().toLocaleTimeString();
    box.insertAdjacentHTML("afterbegin", `<div>${at} — ${line}</div>`);
    const max = 200; while (box.childElementCount > max) box.removeChild(box.lastChild);
  }

  // history/stream are invoked after chart init in whenLCReady()

  async function loadCanary() {
    try {
      const txt = await fetch('/canary/state').then(r=>r.text());
      const st = JSON.parse(txt||'{}');
      const tb = document.querySelector('#canary-table tbody');
      tb.innerHTML = '';
  const stats = st.stats || {};
      let rows = [];
      for (const key in stats) {
        const arms = stats[key] || {};
        for (const arm in arms) {
          const s = arms[arm];
          const avg = s.plays > 0 ? (s.totalReward / s.plays) : 0;
          rows.push({ key, arm, plays: s.plays, avg });
        }
      }
      rows.sort((a,b)=> b.avg - a.avg);
      for (const r of rows.slice(0, 12)) {
        const tr = document.createElement('tr');
        const cls = r.avg>0? 'ok' : (r.avg<0? 'bad':'');
        tr.innerHTML = `<td>${r.key}</td><td>${r.arm}</td><td style="text-align:right">${r.plays}</td><td style="text-align:right" class="${cls}">${fmt2(r.avg)}</td>`;
        tb.appendChild(tr);
      }
      const bl = st.blacklist || {};
      const blCount = Object.values(bl).reduce((n,arr)=> n + (arr?.length||0), 0);
      document.getElementById('canary-summary').innerText = `arms=${rows.length} blacklisted=${blCount}`;

  const meta = st.meta || {};
  const eps = meta.epsilon != null ? Number(meta.epsilon).toFixed(2) : '-';
  const dwell = meta.dwellMinutes ?? '-';
  const window = meta.windowMinutes ?? '-';
  const minPlays = meta.minPlays ?? '-';
  document.getElementById('canary-meta').innerText = `eps=${eps} dwell=${dwell}m window=${window}m minPlays=${minPlays}`;

      const runTb = document.querySelector('#canary-running tbody');
      runTb.innerHTML = '';
      const running = st.running || [];
      for (const e of running) {
        const ageMin = Math.max(0, (Date.now() - new Date(e.appliedUtc).getTime()))/60000;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${e.root}</td><td>${e.regime}</td><td>${e.arm}</td><td style="text-align:right">${ageMin.toFixed(0)}m</td>`;
        runTb.appendChild(tr);
      }
      const blTb = document.querySelector('#canary-blacklist tbody');
      blTb.innerHTML = '';
      const blRows = [];
      for (const key in bl) {
        const arr = bl[key] || [];
        for (const arm of arr) blRows.push({ key, arm });
      }
      blRows.sort((a,b)=> a.key.localeCompare(b.key) || a.arm.localeCompare(b.arm));
      for (const r of blRows.slice(0, 20)) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.key}</td><td>${r.arm}</td>`;
        blTb.appendChild(tr);
      }
    } catch { /* no-op */ }
  }
  setInterval(loadCanary, 15000);
  loadCanary();

  async function loadRetune() {
    try {
      const txt = await fetch('/retune/status').then(r=>r.text());
      const st = JSON.parse(txt||'{}');
      const sum = document.getElementById('retune-summary');
      if (!st.since) { sum.innerText = 'idle'; return; }
      const since = new Date(st.since).toISOString().slice(0,10);
      const until = new Date(st.until).toISOString().slice(0,10);
      sum.innerText = `window ${since} → ${until} (${st.lookbackDays||'-'}d, every ${st.intervalMinutes||'-'}m)`;
      const tb = document.querySelector('#retune-table tbody'); tb.innerHTML = '';
      const rows = (st.results||[]).map(x=>({ root:x.root, strat:x.strat, ok:x.ok, error:x.error }));
      rows.sort((a,b)=> a.root.localeCompare(b.root)||a.strat.localeCompare(b.strat));
      for (const r of rows) {
        const tr = document.createElement('tr');
        const status = r.ok? '<span class="ok">ok</span>' : `<span class="bad">fail</span>`;
        tr.innerHTML = `<td>${r.root||'-'}</td><td>${r.strat||'-'}</td><td>${status}${r.error? ' · '+r.error:''}</td>`;
        tb.appendChild(tr);
      }
    } catch { /* no-op */ }
  }
  setInterval(loadRetune, 20000);
  loadRetune();

  async function loadPerf() {
    try {
      const j = await fetch('/perf/summary?days=10').then(r=>r.json());
      const since = new Date(j.since).toISOString().slice(0,10);
      const until = new Date(j.until).toISOString().slice(0,10);
      document.getElementById('perf-window').innerText = `window ${since} → ${until}`;
      const tb = document.querySelector('#perf-table tbody');
      tb.innerHTML = '';
      const rows = (j.roots||[]).map(x=>({ root:x.root, trades:x.totalTrades||0, usd:x.totalUsd||0, per:x.perStrategy||[] }));
      rows.sort((a,b)=> a.root.localeCompare(b.root));
      for (const r of rows) {
        const per = r.per.map(p=> `${p.strat}:${fmt2(p.netUsd)}(${p.trades})`).join(' · ');
        const cls = r.usd>0? 'ok' : (r.usd<0? 'bad' : '');
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.root}</td><td style="text-align:right">${r.trades}</td><td style="text-align:right" class="${cls}">${fmt2(r.usd)}</td><td>${per}</td>`;
        tb.appendChild(tr);
      }
    } catch {}
  }
  document.getElementById('btn-perf-refresh').addEventListener('click', loadPerf);
  setInterval(loadPerf, 300000); // every 5m
  loadPerf();

  // Canary actions
  document.getElementById('btn-canary-reset').addEventListener('click', async ()=>{
    try { await fetch('/canary/reset', { method:'POST' }); addEvent('canary reset'); loadCanary(); } catch {}
  });
  document.getElementById('btn-canary-clearbl').addEventListener('click', async ()=>{
    try { await fetch('/canary/blacklist/clear', { method:'POST' }); addEvent('canary blacklist cleared'); loadCanary(); } catch {}
  });

  // Learners actions
  document.getElementById('btn-launch-tuner').addEventListener('click', async ()=>{
    const s = document.getElementById('learners-status');
    try {
      s.innerText = 'starting tuner…';
      const resp = await fetch('/learner/tune', { method:'POST' });
      const j = await resp.json();
      if (j.started) { s.innerText = `tuner started (${j.days||'-'}d) roots=${(j.roots||[]).join(',')} strats=${(j.strats||[]).join(',')}`; addEvent('tuner started'); loadRetune(); }
      else { s.innerText = 'tuner failed'; }
    } catch (e) { s.innerText = 'tuner error'; }
  });
  document.getElementById('btn-run-adapt').addEventListener('click', async ()=>{
    const s = document.getElementById('learners-status');
    try {
      s.innerText = 'running adaptive…';
      const resp = await fetch('/learner/adapt', { method:'POST' });
      const j = await resp.json();
      if (j.started) { s.innerText = 'adaptive started'; addEvent('adaptive learner started'); }
      else { s.innerText = 'adaptive failed'; }
    } catch (e) { s.innerText = 'adaptive error'; }
  });
</script>
</body>
</html>
